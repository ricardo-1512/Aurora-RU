<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AURORA X — Decision App</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#070707;
  --card:rgba(255,255,255,.035);
  --border:rgba(255,255,255,.08);
  --muted:rgba(255,255,255,.55);
  --glassA:rgba(34,197,94,.14);
  --glassB:rgba(59,130,246,.12);
}
html,body{background:var(--bg);color:#fff;font-family:system-ui;}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px}
.badge{border:1px solid rgba(255,255,255,.12);padding:.25rem .6rem;border-radius:999px;font-size:10px;letter-spacing:.15em;text-transform:uppercase;color:var(--muted)}
.glow-red{color:#ef4444;text-shadow:0 0 24px rgba(239,68,68,.5)}
.glow-yellow{color:#f59e0b;text-shadow:0 0 22px rgba(245,158,11,.4)}
.glow-green{color:#22c55e;text-shadow:0 0 20px rgba(34,197,94,.4)}
#map{height:240px;border-radius:16px}

/* Light mode */
@media (prefers-color-scheme: light){
  :root{
    --bg:#f6f7f9;
    --card:rgba(0,0,0,.04);
    --border:rgba(0,0,0,.08);
    --muted:rgba(0,0,0,.55);
  }
  html,body{color:#111}
  .badge{background:rgba(0,0,0,.04);color:rgba(0,0,0,.6)}
}
</style>
</head>

<body class="p-4">
<div class="max-w-2xl mx-auto space-y-4">

<!-- HEADER -->
<div class="card p-5">
  <h1 class="text-xl font-black">AURORA <span class="text-green-400">X</span></h1>
  <div class="flex gap-2 mt-2">
    <span class="badge" id="badgeLive">—</span>
    <span class="badge">LAT <span id="uiLat">--</span></span>
    <span class="badge">LON <span id="uiLon">--</span></span>
  </div>
</div>

<!-- MAP -->
<div class="card p-4">
  <div class="flex justify-between mb-2">
    <span class="badge">Karte & Schwellen</span>
    <span class="badge">Night Map</span>
  </div>
  <div id="map"></div>
</div>

<!-- DECISION -->
<div class="card p-6 text-center">
  <div class="badge mb-3">Geh ich raus?</div>
  <div id="mainStatus" class="text-6xl font-black text-white/20">ANALYSE</div>
  <div id="mainRec" class="text-sm text-white/60 italic mt-2">—</div>

  <div class="mt-5">
    <span class="badge">Aurora-Score</span>
    <div class="text-3xl font-black mt-1"><span id="uiScore">--</span>/100</div>
    <div class="h-2 bg-white/10 rounded-full mt-2 overflow-hidden">
      <div id="scoreBar" class="h-full bg-green-500" style="width:0%"></div>
    </div>
    <div id="uiScoreWhy" class="text-xs text-white/55 mt-2"></div>
  </div>

  <!-- MINI FORECAST -->
  <div class="grid grid-cols-3 gap-2 mt-5 text-sm">
    <div class="card p-3">Jetzt<br><b id="fcNow">—</b></div>
    <div class="card p-3">+30 min<br><b id="fc30">—</b></div>
    <div class="card p-3">+60 min<br><b id="fc60">—</b></div>
  </div>
</div>

<!-- VALUES -->
<div class="grid grid-cols-2 gap-3">
  <div class="card p-4">
    <div class="text-xs text-white/50">Sonnenwind</div>
    <div class="text-3xl font-black" id="valSpd">--</div>
    <div class="text-xs text-white/40">km/s</div>
  </div>
  <div class="card p-4">
    <div class="text-xs text-white/50">Bz</div>
    <div class="text-3xl font-black" id="valBz">--</div>
    <div class="text-xs text-white/40">nT</div>
  </div>
</div>

<!-- WEATHER / MOON -->
<div class="card p-4">
  <div class="flex justify-between mb-2">
    <span class="badge">Wetter & Nacht</span>
    <span class="badge" id="uiNight">—</span>
  </div>
  <div class="grid grid-cols-2 gap-3">
    <div class="card p-3">
      Bewölkung<br><b id="valCloud">--</b>
    </div>
    <div class="card p-3">
      Mond<br><b id="valMoon">--</b>
    </div>
  </div>
  <div class="grid grid-cols-2 gap-3 mt-3 text-sm">
    <div>
      Sonnenuntergang<br><b id="sunset">--:--</b>
    </div>
    <div>
      Sonnenaufgang<br><b id="sunrise">--:--</b>
    </div>
  </div>
</div>

<!-- CHART -->
<div class="card p-4">
  <span class="badge mb-2 inline-block">Bz & Speed (~2h)</span>
  <canvas id="chartMain" height="200"></canvas>
</div>

</div>

<script>
/* ---------- HELPERS ---------- */
const $ = id => document.getElementById(id);
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const timeFromISO=i=>i?new Date(i).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}):null;

/* ---------- MAP ---------- */
let map=L.map("map").setView([50.83,12.92],6);
L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{subdomains:"abcd"}).addTo(map);
let marker=L.marker([50.83,12.92],{draggable:true}).addTo(map);

/* Kp Schwellen */
L.circle([63,10],{radius:1200000,color:"#f59e0b",fill:false}).addTo(map);
L.circle([68,10],{radius:800000,color:"#ef4444",fill:false}).addTo(map);

/* ---------- DATA ---------- */
async function fetchJson(u){try{return await (await fetch(u)).json()}catch{return null}}

/* ---------- MAIN ---------- */
async function update(){
  $("badgeLive").textContent="live";

  const mag=await fetchJson("https://services.swpc.noaa.gov/products/summary/solar-wind-mag-field.json");
  const spd=await fetchJson("https://services.swpc.noaa.gov/products/summary/solar-wind-speed.json");

  const bz=Number(mag?.bz ?? null);
  const speed=Number(spd?.wind_speed ?? null);

  $("valBz").textContent=bz?.toFixed(1)||"--";
  $("valSpd").textContent=Math.round(speed)||"--";

  const wx=await fetchJson(`https://api.open-meteo.com/v1/forecast?latitude=50.83&longitude=12.92&current=cloud_cover,is_day&daily=sunrise,sunset,moon_illumination&timezone=auto`);
  const cloud=wx?.current?.cloud_cover;
  const night=wx?.current?.is_day===0;

  $("valCloud").textContent=cloud!=null?cloud+"%":"--";
  $("valMoon").textContent=wx?.daily?.moon_illumination?.[0]!=null?Math.round(wx.daily.moon_illumination[0])+"%":"--";
  $("sunrise").textContent=timeFromISO(wx?.daily?.sunrise?.[0])||"--:--";
  $("sunset").textContent=timeFromISO(wx?.daily?.sunset?.[0])||"--:--";
  $("uiNight").textContent=night?"Nacht":"Tag";

  /* SCORE */
  let score=0;
  if(bz<0)score+=(-bz)*3;
  if(speed>400)score+=(speed-400)/8;
  if(!night)score*=0.25;
  if(cloud!=null)score*=(100-cloud)/100;
  score=Math.round(clamp(score,0,100));

  $("uiScore").textContent=score;
  $("fcNow").textContent=score;
  $("fc30").textContent=clamp(score+6,0,100);
  $("fc60").textContent=clamp(score+10,0,100);
  $("scoreBar").style.width=score+"%";
  $("uiScoreWhy").textContent=`Bz ${bz?.toFixed(1)} • Speed ${Math.round(speed)} • ${night?"Nacht":"Tag"}`;

  const st=$("mainStatus");
  st.className="text-6xl font-black";
  if(score>70){st.textContent="ALARM";st.classList.add("glow-red");$("mainRec").textContent="Raus! Sehr gute Bedingungen."}
  else if(score>40){st.textContent="CHANCE";st.classList.add("glow-yellow");$("mainRec").textContent="Beobachten, Kamera bereit."}
  else{st.textContent="RUHIG";$("mainRec").textContent="Aktuell eher nichts."}
}

update();
setInterval(update,60000);
</script>
</body>
</html>
