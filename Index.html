<!DOCTYPE html>
<html lang="de" data-theme="system">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AURORA X ‚Äî v8.0 Extreme Mobile</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#070707;
      --card: rgba(255,255,255,.04);
      --border: rgba(255,255,255,.10);
      --muted: rgba(255,255,255,.55);
      --text: rgba(255,255,255,.92);
      --title: rgba(255,255,255,.92);
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --chip: rgba(0,0,0,.30);
    }
    html,body{ background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui; }
    .card{ background: var(--card); border: 1px solid var(--border); border-radius: 18px; box-shadow: var(--shadow); }
    .badge{
      border: 1px solid rgba(127,127,127,.18);
      background: var(--chip);
      border-radius: 999px;
      padding: .25rem .6rem;
      font-size: 10px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: var(--muted);
      display:inline-flex;
      gap:.4rem;
      align-items:center;
      white-space:nowrap;
    }
    .btn{
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 11px;
      font-weight: 900;
      letter-spacing: .12em;
      text-transform: uppercase;
      border: 1px solid rgba(127,127,127,.18);
      user-select:none;
    }
    .btn-primary{ background:#22c55e; color:#052e16; }
    .btn:active{ transform: translateY(1px); }

    #map{ height: 260px; border-radius: 16px; overflow:hidden; border:1px solid rgba(127,127,127,.15); }
    .img-frame{ border-radius: 16px; overflow:hidden; border:1px solid rgba(127,127,127,.15); background: rgba(0,0,0,.15); }
    .img-frame img{ width:100%; display:block; }

    /* Splash */
    #splash{ position:fixed; inset:0; z-index:999999; display:flex; justify-content:center; align-items:center; background:black; }

    /* Tabs */
    .tabs{
      position:fixed; left:0; right:0; bottom:0;
      padding:10px 12px env(safe-area-inset-bottom);
      background:rgba(10,10,10,.85);
      border-top:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(18px);
      z-index:99999;
    }
    .tabs-inner{ max-width:720px; margin:0 auto; display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
    .tab{
      padding:16px 10px;
      border-radius:16px;
      text-align:center;
      font-size:11px;
      font-weight:900;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--muted);
      background:rgba(127,127,127,.10);
      border:1px solid rgba(255,255,255,.06);
    }
    .tab.active{ background:rgba(34,197,94,.20); border:1px solid rgba(34,197,94,.40); color:var(--title); }
    .pb-tabs{ padding-bottom:110px; }

    /* Status colors */
    .status-alarm{ color:#ef4444; text-shadow: 0 0 24px rgba(239,68,68,.25); }
    .status-chance{ color:#f59e0b; text-shadow: 0 0 24px rgba(245,158,11,.18); }
    .status-quiet{ color:rgba(255,255,255,.45); }
  </style>
</head>

<body class="p-4 pb-tabs">

  <!-- SPLASH -->
  <div id="splash">
    <div class="text-center">
      <div class="text-3xl font-black text-white tracking-tight">
        AURORA <span class="text-green-400">X</span>
      </div>
      <div class="mt-3 text-sm text-white/60">GPS & Sensoren werden geladen‚Ä¶</div>
      <div class="mt-6 w-44 h-1 bg-white/10 rounded-full overflow-hidden">
        <div id="splashBar" class="h-full bg-green-400 w-0"></div>
      </div>
      <div class="mt-3 text-[11px] text-white/40" id="splashMsg">Start‚Ä¶</div>
    </div>
  </div>

  <div class="max-w-2xl mx-auto">

    <!-- NOW -->
    <section id="secNow" class="card p-5 mb-4">
      <div class="flex justify-between items-start gap-3">
        <div>
          <h1 class="text-xl font-black tracking-tight">
            AURORA <span class="text-green-400">X</span>
          </h1>

          <div class="flex gap-2 mt-2 flex-wrap">
            <span class="badge" id="badgeLive">offline</span>
            <span class="badge" id="cityName">üìç Standort‚Ä¶</span>
          </div>
        </div>

        <button id="btnUpdate" class="btn btn-primary">Update</button>
      </div>

      <div class="mt-6 text-center">
        <div class="badge mx-auto mb-3">Geh ich raus?</div>
        <div id="mainStatus" class="text-6xl font-black">‚Äî</div>
        <div id="mainRec" class="mt-2 text-sm text-white/60 italic">Analyse l√§uft‚Ä¶</div>

        <div class="mt-6 flex justify-center gap-2 flex-wrap">
          <span class="badge">Kp: <span id="chipKp">--</span></span>
          <span class="badge">Bz: <span id="chipBz">--</span></span>
          <span class="badge">Wolken: <span id="chipCloud">--</span></span>
          <span class="badge">Nacht: <span id="uiNight">--</span></span>
        </div>

        <div class="mt-4 text-[11px] text-white/45" id="miniWhy">‚Äî</div>
      </div>
    </section>

    <!-- MAP -->
    <section id="secMap" class="card p-4 mb-4">
      <div class="flex justify-between mb-2">
        <div class="badge">Interaktive Karte</div>
        <span class="badge">Drag & Zoom</span>
      </div>
      <div id="map"></div>
      <div class="mt-3 text-[11px] text-white/45">
        Tipp: Pin auf dunklen Spot ziehen ‚Üí Wolken pr√ºfen ‚Üí Testshots (Norden).
      </div>
    </section>

    <!-- WEATHER -->
    <section id="secWeather" class="card p-4 mb-4">
      <div class="badge mb-3">Wetter & Sonne</div>

      <div class="grid grid-cols-2 gap-3">
        <div class="card p-3">
          <div class="text-sm text-white/60">Bew√∂lkung</div>
          <div class="text-2xl font-black" id="valCloud">--%</div>
          <div class="text-[11px] text-white/45" id="valCloudTxt">‚Äî</div>
        </div>

        <div class="card p-3">
          <div class="text-sm text-white/60">Mond</div>
          <div class="text-2xl font-black" id="valMoon">--%</div>
          <div class="text-[11px] text-white/45" id="valMoonTxt">‚Äî</div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3 mt-3 text-sm">
        <div>
          <div class="text-white/50">Sonnenaufgang</div>
          <div id="sunrise" class="font-black">--:--</div>
        </div>
        <div>
          <div class="text-white/50">Sonnenuntergang</div>
          <div id="sunset" class="font-black">--:--</div>
        </div>
      </div>

      <div class="mt-3 text-[11px] text-white/45" id="nightNote">
        F√ºr Polarlichter z√§hlt echte Dunkelheit (Nacht/ D√§mmerung) + klare Sicht.
      </div>
    </section>

    <!-- CHART -->
    <section id="secCharts" class="card p-4 mb-4">
      <div class="flex items-center justify-between mb-2">
        <div class="badge">Bz Trend (letzte ~2h)</div>
        <span class="badge" id="chartTag">live</span>
      </div>
      <canvas id="chartMain" height="180"></canvas>
      <div class="mt-2 text-[11px] text-white/45">
        Faustregel: <span class="text-white/70">negativer</span> Bz hilft. Wenn Bz Richtung 0 dreht, schlie√üt sich das Fenster oft wieder.
      </div>
    </section>

    <!-- MORE -->
    <section id="secMore" class="card p-4 mb-8">
      <div class="badge mb-3">Live Monitoring</div>

      <div class="mb-4">
        <div class="flex items-center justify-between mb-2">
          <div class="text-[11px] text-white/55">MTWetter ‚Äî Deutschlandkarte</div>
          <span class="badge" id="mtTime">‚Äî</span>
        </div>
        <div class="img-frame">
          <img id="mtMap" alt="MTWetter Deutschland" />
        </div>
      </div>

      <div class="mb-4">
        <div class="flex items-center justify-between mb-2">
          <div class="text-[11px] text-white/55">GFZ ‚Äî Kp Nowcast Quicklook</div>
          <span class="badge" id="gfzTime">‚Äî</span>
        </div>
        <div class="img-frame">
          <img id="gfzMag" alt="GFZ Kp Quicklook" />
        </div>
      </div>

      <div>
        <div class="flex items-center justify-between mb-2">
          <div class="text-[11px] text-white/55">NOAA ‚Äî Ovation Oval (NH)</div>
          <span class="badge" id="ovaTime">‚Äî</span>
        </div>
        <div class="img-frame">
          <img id="ovationGlobal" alt="NOAA Ovation" />
        </div>
      </div>
    </section>

  </div>

  <!-- Bottom Tabs -->
  <div class="tabs">
    <div class="tabs-inner">
      <div class="tab active" data-target="secNow">Jetzt</div>
      <div class="tab" data-target="secMap">Karte</div>
      <div class="tab" data-target="secCharts">Charts</div>
      <div class="tab" data-target="secMore">Mehr</div>
    </div>
  </div>

<script>
/***********************
 * AURORA X v8.0 ‚Äî Extreme Mobile
 ***********************/
const $ = (id) => document.getElementById(id);

/* Splash */
function splashProgress(p, msg){
  $("splashBar").style.width = `${p}%`;
  if(msg) $("splashMsg").textContent = msg;
}
function hideSplash(){ $("splash").style.display = "none"; }

/* Utils */
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function fmtTimeLocal(d=new Date()){ return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}); }

function isErr(x){ return !!(x && typeof x === "object" && x.__error); }

async function fetchJson(url, timeoutMs=12000){
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), timeoutMs);
  try{
    const res = await fetch(url, { cache:"no-store", signal: ctrl.signal });
    if(!res.ok) return { __error:true, status:res.status, statusText:res.statusText };
    return await res.json();
  }catch(e){
    return { __error:true, message:String(e.message || e) };
  }finally{
    clearTimeout(t);
  }
}
function extractHHMM(iso){
  if(!iso) return null;
  const d = new Date(iso);
  if(isNaN(d)) return null;
  return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
}
function lastValidRow(table, idx){
  if(!Array.isArray(table)) return null;
  for(let i=table.length-1; i>=1; i--){
    const v = Number(table[i]?.[idx]);
    if(Number.isFinite(v)) return table[i];
  }
  return null;
}

/***********************
 * Endpoints
 ***********************/
const NOAA = {
  mag1d: "https://services.swpc.noaa.gov/products/solar-wind/mag-1-day.json",
  plasma1d: "https://services.swpc.noaa.gov/products/solar-wind/plasma-1-day.json",
  kp: "https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json",
  ovation: "https://services.swpc.noaa.gov/images/aurora-forecast-northern-hemisphere.jpg"
};
const SUN_API = (lat, lon) => `https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lon}&formatted=0`;
const OPEN_METEO = (lat, lon) =>
  `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}` +
  `&current=cloud_cover,is_day` +
  `&daily=moon_illumination` +
  `&timezone=auto`;

/* GFZ quicklook (daily png) */
function gfzQuicklookUrlYYYYMMDD(yyyy_mm_dd){
  return `https://kp.gfz-potsdam.de/fileadmin/kp-archiv/png/${yyyy_mm_dd}.png`;
}

/***********************
 * State
 ***********************/
let currentLat = 50.83;
let currentLon = 12.92;
let map, marker;
let chartMain = null;

/***********************
 * GPS + City
 ***********************/
async function initGPS(){
  return new Promise((resolve) => {
    if(!navigator.geolocation){ resolve(); return; }
    navigator.geolocation.getCurrentPosition(
      (pos) => { currentLat = pos.coords.latitude; currentLon = pos.coords.longitude; resolve(); },
      () => resolve(),
      { enableHighAccuracy:true, timeout:9000 }
    );
  });
}

async function reverseGeocodeCity(){
  const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLat}&lon=${currentLon}`;
  const data = await fetchJson(url, 9000);
  if(isErr(data)){ $("cityName").textContent = "üìç Unbekannt"; return; }
  const city = data.address?.city || data.address?.town || data.address?.village || "Standort";
  $("cityName").textContent = `üìç ${city}`;
}

/***********************
 * Map
 ***********************/
function setupMap(){
  map = L.map("map", {
    zoomControl: true,
    dragging: true,
    tap: true,
    scrollWheelZoom: false
  }).setView([currentLat, currentLon], 8);

  L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", { maxZoom: 18 }).addTo(map);

  marker = L.marker([currentLat, currentLon], { draggable:true }).addTo(map);
  marker.on("dragend", () => {
    const p = marker.getLatLng();
    currentLat = p.lat;
    currentLon = p.lng;
    reverseGeocodeCity();
    updateAll();
  });
}

/***********************
 * Score + Decision
 ***********************/
function computeScore({kp,bz,spd,cloud,moon,isNight}){
  let score = 0;

  if(kp !== null) score += kp * 12;                 // Kp 5 => 60
  if(bz !== null && bz < 0) score += Math.abs(bz) * 2.0;  // Bz -10 => +20
  if(spd !== null && spd > 450) score += (spd - 450) * 0.05; // 650 => +10

  if(cloud !== null) score -= cloud * 0.6;
  if(moon !== null) score -= (moon/100) * 15;
  if(!isNight) score -= 50;

  if(cloud !== null && cloud > 90) score *= 0.10;
  if(cloud !== null && cloud >= 98) score = 0;

  return clamp(Math.round(score), 0, 100);
}

function setStatus(label, cls, rec){
  const el = $("mainStatus");
  el.className = `text-6xl font-black ${cls}`;
  el.textContent = label;
  $("mainRec").textContent = rec;
}

function decideStatus(score, meta){
  const { isNight, cloud } = meta || {};
  if(score >= 70 && isNight){
    setStatus("ALARM", "status-alarm", "Raus! Richtung Norden. Testshots. Dunkler Spot.");
    return;
  }
  if(score >= 40 && isNight){
    setStatus("CHANCE", "status-chance", "Beobachten. Kamera bereit halten. Norden testen.");
    return;
  }
  if(!isNight){
    setStatus("RUHIG", "status-quiet", "Zu hell (Tag/D√§mmerung). Sp√§ter nochmal checken.");
    return;
  }
  if(cloud !== null && cloud > 85){
    setStatus("RUHIG", "status-quiet", "Zu wolkig. Spot wechseln oder L√ºcke abwarten.");
    return;
  }
  setStatus("RUHIG", "status-quiet", "Aktuell eher nichts. Sp√§ter nochmal checken.");
}

/***********************
 * Chart (Bz)
 ***********************/
function renderChart(labels, bzVals){
  const ctx = $("chartMain").getContext("2d");
  if(chartMain) chartMain.destroy();

  chartMain = new Chart(ctx, {
    type:"line",
    data:{
      labels,
      datasets:[{
        label:"Bz (nT)",
        data:bzVals,
        borderWidth:2,
        pointRadius:0,
        tension:0.35
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      animation:false,
      plugins:{ legend:{display:false} },
      scales:{
        x:{ ticks:{ maxTicksLimit:6, color:"rgba(255,255,255,.55)" }, grid:{ color:"rgba(255,255,255,.08)" } },
        y:{ ticks:{ color:"rgba(255,255,255,.55)" }, grid:{ color:"rgba(255,255,255,.08)" } }
      }
    }
  });
}

/***********************
 * Live Maps
 ***********************/
function safeImg(id){
  const el = $(id);
  if(!el) return;
  el.onerror = () => {
    el.style.opacity = "0.35";
    el.title = "Bild aktuell nicht erreichbar";
  };
}

function refreshMTWetter(){
  const ts = Date.now();
  $("mtMap").src = `https://aurora.mtwetter.de/forecast/aurora_map.png?ts=${ts}`;
  $("mtTime").textContent = fmtTimeLocal();
}

function refreshGFZQuicklook(){
  const d = new Date();
  const yyyy_mm_dd = d.toISOString().slice(0,10);
  $("gfzMag").src = `${gfzQuicklookUrlYYYYMMDD(yyyy_mm_dd)}?ts=${Date.now()}`;
  $("gfzTime").textContent = fmtTimeLocal();
}

function refreshOvation(){
  $("ovationGlobal").src = `${NOAA.ovation}?ts=${Date.now()}`;
  $("ovaTime").textContent = fmtTimeLocal();
}

function refreshAllMaps(){
  refreshMTWetter();
  refreshGFZQuicklook();
  refreshOvation();
}

/***********************
 * Main update
 ***********************/
async function updateAll(){
  $("badgeLive").textContent = "lade‚Ä¶";

  if(map && marker){
    marker.setLatLng([currentLat, currentLon]);
    map.setView([currentLat, currentLon], map.getZoom());
  }

  const [mag, plasma, kpTable] = await Promise.all([
    fetchJson(NOAA.mag1d, 12000),
    fetchJson(NOAA.plasma1d, 12000),
    fetchJson(NOAA.kp, 12000)
  ]);

  let bz = null, spd = null, kp = null;

  if(Array.isArray(mag)){
    const last = lastValidRow(mag, 3);
    bz = last ? Number(last[3]) : null;
  }

  if(Array.isArray(plasma)){
    const last = lastValidRow(plasma, 2);
    spd = last ? Number(last[2]) : null;
  }

  if(Array.isArray(kpTable)){
    const rows = kpTable.filter(r => r?.[0] && !isNaN(Date.parse(r[0])));
    if(rows.length){
      kp = Number(rows[rows.length-1][1]);
    }
  }

  let cloud = null, moonIllum = null, isNight = false;

  const wx = await fetchJson(OPEN_METEO(currentLat, currentLon), 12000);
  if(!isErr(wx)){
    cloud = (wx.current?.cloud_cover ?? null);
    isNight = (wx.current?.is_day === 0);

    const mi = wx.daily?.moon_illumination?.[0] ?? null;
    if(mi !== null){
      const pct = (mi <= 1.01) ? mi * 100 : mi;
      moonIllum = clamp(pct, 0, 100);
    }
  }

  const sun = await fetchJson(SUN_API(currentLat, currentLon), 12000);
  if(!isErr(sun) && sun?.results){
    $("sunrise").textContent = extractHHMM(sun.results.sunrise) || "--:--";
    $("sunset").textContent  = extractHHMM(sun.results.sunset)  || "--:--";
  }else{
    $("sunrise").textContent = "--:--";
    $("sunset").textContent  = "--:--";
  }

  $("chipBz").textContent = (bz !== null) ? bz.toFixed(1) : "--";
  $("chipKp").textContent = (kp !== null) ? kp.toFixed(1) : "--";
  $("chipCloud").textContent = (cloud !== null) ? `${Math.round(cloud)}%` : "--";
  $("uiNight").textContent = isNight ? "Ja" : "Nein";

  $("valCloud").textContent = (cloud !== null) ? `${Math.round(cloud)}%` : "--%";
  $("valMoon").textContent  = (moonIllum !== null) ? `${Math.round(moonIllum)}%` : "--%";

  if(cloud === null){
    $("valCloudTxt").textContent = "‚Äî";
  }else if(cloud >= 85){
    $("valCloudTxt").textContent = "Wolkig";
  }else if(cloud >= 35){
    $("valCloudTxt").textContent = "Teils klar";
  }else{
    $("valCloudTxt").textContent = "Klar";
  }

  if(moonIllum === null){
    $("valMoonTxt").textContent = "‚Äî";
  }else if(moonIllum >= 75){
    $("valMoonTxt").textContent = "Hell";
  }else if(moonIllum >= 35){
    $("valMoonTxt").textContent = "Mittel";
  }else{
    $("valMoonTxt").textContent = "Dunkel (top)";
  }

  const score = computeScore({ kp, bz, spd, cloud, moon: moonIllum, isNight });

  $("miniWhy").textContent =
    `Score ${score}/100 ‚Ä¢ ` +
    `${isNight ? "Nacht" : "Tag/D√§mmerung"} ‚Ä¢ ` +
    `Kp ${kp !== null ? kp.toFixed(1) : "‚Äî"} ‚Ä¢ ` +
    `Bz ${bz !== null ? bz.toFixed(1) : "‚Äî"} ‚Ä¢ ` +
    `${cloud !== null ? Math.round(cloud)+"% Wolken" : "Wolken ‚Äî"}`;

  decideStatus(score, { isNight, cloud });

  if(Array.isArray(mag)){
    const slice = mag.slice(-70);
    const labels = [];
    const bzVals = [];
    for(const r of slice){
      const t = extractHHMM(r?.[0]);
      const v = Number(r?.[3]);
      if(t) labels.push(t);
      bzVals.push(Number.isFinite(v) ? v : null);
    }
    renderChart(labels, bzVals);
  }

  $("badgeLive").textContent = "live";

  refreshAllMaps();
}

/***********************
 * Events
 ***********************/
$("btnUpdate").addEventListener("click", updateAll);

document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    const id = tab.getAttribute("data-target");
    const el = document.getElementById(id);
    if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
  });
});

/***********************
 * INIT
 ***********************/
async function init(){
  safeImg("mtMap");
  safeImg("gfzMag");
  safeImg("ovationGlobal");

  splashProgress(10, "GPS‚Ä¶");
  await initGPS();

  splashProgress(35, "Karte‚Ä¶");
  setupMap();

  splashProgress(55, "Ort‚Ä¶");
  await reverseGeocodeCity();

  splashProgress(75, "Sensoren‚Ä¶");
  await updateAll();

  splashProgress(100, "Fertig");
  setTimeout(hideSplash, 350);

  setInterval(updateAll, 60000);
  setInterval(refreshAllMaps, 300000);
}

init();
</script>
</body>
</html>
