<!DOCTYPE html>
<html lang="de" data-theme="system">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AURORA X ‚Äî v6.1 (Kp Fix ‚Ä¢ Weather Fix ‚Ä¢ Diagnostics)</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#070707;
      --card: rgba(255,255,255,.035);
      --border: rgba(255,255,255,.08);
      --muted: rgba(255,255,255,.55);
      --muted2: rgba(255,255,255,.35);
      --glassA: rgba(34,197,94,.14);
      --glassB: rgba(59,130,246,.10);
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --text: rgba(255,255,255,.92);
      --title: rgba(255,255,255,.92);
      --sub: rgba(255,255,255,.62);
      --dim: rgba(255,255,255,.18);
      --chip: rgba(0,0,0,.28);
      --input: rgba(0,0,0,.45);
      --tabbg: rgba(10,10,10,.70);
      --tabbd: rgba(255,255,255,.10);
    }

    @media (prefers-color-scheme: light){
      html[data-theme="system"]{
        --bg:#f3f4f6;
        --card: rgba(0,0,0,.035);
        --border: rgba(0,0,0,.08);
        --muted: rgba(0,0,0,.55);
        --muted2: rgba(0,0,0,.35);
        --glassA: rgba(34,197,94,.18);
        --glassB: rgba(59,130,246,.12);
        --shadow: 0 20px 60px rgba(0,0,0,.10);
        --text: rgba(0,0,0,.88);
        --title: rgba(0,0,0,.92);
        --sub: rgba(0,0,0,.62);
        --dim: rgba(0,0,0,.22);
        --chip: rgba(255,255,255,.55);
        --input: rgba(255,255,255,.75);
        --tabbg: rgba(255,255,255,.70);
        --tabbd: rgba(0,0,0,.10);
      }
    }

    html[data-theme="light"]{
      --bg:#f3f4f6;
      --card: rgba(0,0,0,.035);
      --border: rgba(0,0,0,.08);
      --muted: rgba(0,0,0,.55);
      --muted2: rgba(0,0,0,.35);
      --glassA: rgba(34,197,94,.18);
      --glassB: rgba(59,130,246,.12);
      --shadow: 0 20px 60px rgba(0,0,0,.10);
      --text: rgba(0,0,0,.88);
      --title: rgba(0,0,0,.92);
      --sub: rgba(0,0,0,.62);
      --dim: rgba(0,0,0,.22);
      --chip: rgba(255,255,255,.55);
      --input: rgba(255,255,255,.75);
      --tabbg: rgba(255,255,255,.70);
      --tabbd: rgba(0,0,0,.10);
    }

    html,body{
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

    .glass{
      background:
        radial-gradient(900px 420px at 15% -10%, var(--glassA), transparent 60%),
        radial-gradient(800px 400px at 95% 0%, var(--glassB), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border: 1px solid var(--border);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
    }
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 16px 50px rgba(0,0,0,.18);
    }
    .badge{
      border: 1px solid rgba(127,127,127,.18);
      background: var(--chip);
      border-radius: 999px;
      padding: .25rem .55rem;
      font-size: 10px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: var(--sub);
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      white-space: nowrap;
      max-width: 100%;
    }

    .input{
      background: var(--input);
      border: 1px solid rgba(127,127,127,.18);
      border-radius: 12px;
      padding: 12px 12px;
      color: var(--title);
      outline: none;
    }
    .input:focus{
      border-color: rgba(34,197,94,.55);
      box-shadow: 0 0 0 3px rgba(34,197,94,.15);
    }

    .btn{
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 11px;
      font-weight: 900;
      letter-spacing: .12em;
      text-transform: uppercase;
      transition: transform .08s ease, filter .2s ease;
      user-select: none;
      border: 1px solid rgba(127,127,127,.18);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn-primary{ background: #22c55e; color:#052e16; border-color: rgba(34,197,94,.55); }
    .btn-ghost{ background: rgba(255,255,255,.10); color: var(--title); }
    .btn-mini{ padding: 10px 12px; font-size: 10px; border-radius: 999px; width:auto; }

    .glow-red{ color:#ef4444; text-shadow: 0 0 24px rgba(239,68,68,.35); }
    .glow-yellow{ color:#f59e0b; text-shadow: 0 0 24px rgba(245,158,11,.25); }
    .glow-green{ color:#22c55e; text-shadow: 0 0 24px rgba(34,197,94,.25); }

    /* Map */
    #map{
      height: 300px;
      border-radius: 16px;
      border: 1px solid rgba(127,127,127,.18);
      overflow: hidden;
    }

    /* Charts */
    .chart-wrap{ height: 220px; width:100%; position: relative; }
    canvas{ max-width: 100% !important; }

    /* Autocomplete */
    .ac{ position: relative; }
    .ac-list{
      position:absolute;
      top: calc(100% + 8px);
      left:0; right:0;
      z-index: 9999;
      background: rgba(18,18,18,.98);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      overflow:hidden;
      box-shadow: 0 16px 50px rgba(0,0,0,.35);
    }
    @media (prefers-color-scheme: light){
      html[data-theme="system"] .ac-list{ background: rgba(255,255,255,.98); border-color: rgba(0,0,0,.10); }
    }
    html[data-theme="light"] .ac-list{ background: rgba(255,255,255,.98); border-color: rgba(0,0,0,.10); }

    .ac-item{
      padding: 12px 12px;
      border-top: 1px solid rgba(127,127,127,.12);
      cursor: pointer;
      font-size: 13px;
      color: var(--title);
    }
    .ac-item:first-child{ border-top:none; }
    .ac-item:hover{ background: rgba(127,127,127,.10); }

    /* Images */
    .img-frame{
      border-radius: 16px;
      border: 1px solid rgba(127,127,127,.18);
      overflow: hidden;
      background: rgba(0,0,0,.10);
    }
    .img-frame img{ width:100%; height:auto; display:block; }

    .europe-crop{
      width:100%;
      height: 230px;
      object-fit: cover;
      object-position: 65% 60%;
      display:block;
    }

    /* Bottom Tabs */
    .tabs{
      position: fixed;
      left: 0; right: 0;
      bottom: 0;
      z-index: 99999;
      padding: 10px 12px env(safe-area-inset-bottom);
      background: var(--tabbg);
      border-top: 1px solid var(--tabbd);
      backdrop-filter: blur(18px);
    }
    .tabs-inner{
      max-width: 720px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .tab{
      background: rgba(127,127,127,.12);
      border: 1px solid rgba(127,127,127,.18);
      border-radius: 16px;
      padding: 12px 10px;
      text-align: center;
      font-weight: 900;
      letter-spacing: .16em;
      font-size: 10px;
      text-transform: uppercase;
      color: var(--sub);
      user-select: none;
    }
    .tab.active{
      background: rgba(34,197,94,.18);
      border-color: rgba(34,197,94,.40);
      color: var(--title);
    }

    .pb-tabs{ padding-bottom: 92px; }

    /* Threshold pills */
    .th-row{
      display:flex; align-items:flex-start; gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(127,127,127,.18);
      background: rgba(127,127,127,.08);
    }
    .dot{
      width: 12px; height:12px; border-radius:999px; margin-top: 4px;
      box-shadow: 0 0 0 4px rgba(127,127,127,.12);
      flex: 0 0 auto;
    }
    .dot.gray{ background:#9ca3af; box-shadow:0 0 0 4px rgba(156,163,175,.14); }
    .dot.green{ background:#22c55e; box-shadow:0 0 0 4px rgba(34,197,94,.14); }
    .dot.yellow{ background:#f59e0b; box-shadow:0 0 0 4px rgba(245,158,11,.14); }
    .dot.red{ background:#ef4444; box-shadow:0 0 0 4px rgba(239,68,68,.14); }

    .muted{ color: var(--muted); }
    .muted2{ color: var(--muted2); }

    /* Small diagnostic line */
    .diag{
      font-size: 11px;
      color: var(--muted2);
      margin-top: 6px;
      word-break: break-word;
    }
  </style>
</head>

<body class="p-4 md:p-6 pb-tabs">
  <div class="max-w-2xl mx-auto">

    <!-- HEADER -->
    <section id="secNow" class="glass rounded-2xl p-5 mb-4">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h1 class="text-xl font-black tracking-tight" style="color:var(--title)">AURORA <span class="text-green-500">X</span></h1>
          <div class="flex flex-wrap gap-2 mt-2">
            <span class="badge" id="badgeLive">offline</span>
            <span class="badge">LAT: <span class="mono" id="uiLat">--</span></span>
            <span class="badge">LON: <span class="mono" id="uiLon">--</span></span>
          </div>
        </div>

        <div class="text-right">
          <div class="text-[10px] mono muted2">Letztes Update</div>
          <div class="text-[13px] mono" style="color:var(--sub)" id="uiUpdated">--:--</div>

          <div class="mt-3 flex justify-end gap-2">
            <button class="btn btn-ghost btn-mini" id="btnTheme" title="Theme umschalten (System/Light/Dark)">‚òÄÔ∏é/‚òæ</button>
            <button class="btn btn-ghost btn-mini" id="btnGPS" title="Standort per GPS">üìç</button>
          </div>
        </div>
      </div>

      <div class="mt-4 text-xs muted">
        Tipp: Pin auf dunklen Spot ziehen ‚Üí Wolken pr√ºfen ‚Üí Testshots (Norden).
      </div>
    </section>

    <!-- ORT & KARTE -->
    <section id="secMap" class="card p-4 mb-4">
      <div class="flex items-center justify-between mb-3">
        <div class="text-[10px] uppercase font-black tracking-[.25em] muted">Ort & Karte</div>
        <span class="badge" id="mapModeBadge">‚Äî</span>
      </div>

      <div class="grid grid-cols-1 gap-3 mb-3">
        <div class="ac">
          <input id="placeInput" class="input w-full text-sm" placeholder="Ort suchen (z. B. Chemnitz, Leipzig, Berlin) ‚Ä¶" autocomplete="off">
          <div id="acList" class="ac-list hidden"></div>
        </div>

        <button class="btn btn-primary" id="btnUpdate">Update</button>

        <!-- optional: minimal status, statt Overlay-Texte -->
        <div class="flex flex-wrap gap-2">
          <span class="badge" id="chipOverlay">OVAL</span>
          <span class="badge" id="chipNightline">NACHT</span>
        </div>
      </div>

      <div id="map"></div>
    </section>

    <!-- DECISION + SCORE + LEGEND -->
    <section class="card p-8 text-center mb-4">
      <div class="badge mx-auto mb-4">Geh ich raus?</div>

      <div id="mainStatus" class="text-6xl font-black tracking-tight" style="color:var(--title)">ANALYSE</div>
      <div class="mt-2 text-sm italic muted px-2" id="mainRec">Daten werden geladen ‚Ä¶</div>

      <div class="mt-6">
        <div class="flex items-center justify-center gap-2 mb-3 flex-wrap">
          <span class="badge">Aurora-Score</span>
          <span class="text-3xl font-black mono" id="uiScore" style="color:var(--title)">--</span>
          <span class="text-sm muted">/ 100</span>
        </div>

        <div class="h-2 w-full bg-black/10 rounded-full overflow-hidden" style="border:1px solid rgba(127,127,127,.18)">
          <div id="scoreBar" class="h-full" style="width:0%"></div>
        </div>

        <div class="mt-3 text-[12px] muted" id="uiScoreWhy">‚Äî</div>
      </div>

      <div class="flex flex-wrap justify-center gap-2 mt-7">
        <span class="badge">Bz: <span id="chipBz" class="mono">--</span><span id="chipBzTrend" class="mono"></span> nT</span>
        <span class="badge">Speed: <span id="chipSpd" class="mono">--</span> km/s</span>
        <span class="badge">Kp: <span id="chipKp" class="mono">--</span></span>
        <span class="badge">Wolken: <span id="chipCloud" class="mono">--</span></span>
        <span class="badge">Mond: <span id="chipMoon" class="mono">--</span></span>
        <span class="badge" id="uiNight">‚Äî</span>
      </div>

      <div class="card p-4 mt-6 text-left">
        <div class="flex items-center justify-between mb-2">
          <div class="text-[10px] uppercase font-black tracking-[.25em] muted">Schwellen (DE-Richtwerte)</div>
          <span class="badge">kurz & klar</span>
        </div>

        <div class="grid gap-2">
          <div class="th-row">
            <div class="dot gray"></div>
            <div>
              <div class="font-black" style="color:var(--title)">RUHIG</div>
              <div class="text-sm muted">
                Himmel zu hell <span class="muted2">oder</span> Werte/Wolken unpraktisch ‚Üí sp√§ter erneut pr√ºfen.
              </div>
            </div>
          </div>

          <div class="th-row">
            <div class="dot yellow"></div>
            <div>
              <div class="font-black" style="color:var(--title)">CHANCE</div>
              <div class="text-sm muted">
                Dunkel genug + halbwegs klar und <span class="mono">Kp ‚â• 4</span> <span class="muted2">oder</span> <span class="mono">Bz ‚â§ -6</span>
              </div>
            </div>
          </div>

          <div class="th-row">
            <div class="dot green"></div>
            <div>
              <div class="font-black" style="color:var(--title)">GUT</div>
              <div class="text-sm muted">
                <span class="mono">Kp ‚â• 5</span> + <span class="mono">Bz ‚â§ -8</span> + <span class="mono">Speed ‚â• 500</span>
              </div>
            </div>
          </div>

          <div class="th-row">
            <div class="dot red"></div>
            <div>
              <div class="font-black" style="color:var(--title)">ALARM</div>
              <div class="text-sm muted">
                <span class="mono">Kp ‚â• 7</span> <span class="muted2">oder</span> (<span class="mono">Bz ‚â§ -12</span> + <span class="mono">Speed ‚â• 600</span>) + m√∂glichst klar
              </div>
            </div>
          </div>
        </div>

        <div class="text-[12px] muted mt-3">
          Wichtig: In Deutschland entscheidet oft <b>Dunkelheit</b> + Sicht. Testshots > Theorie.
        </div>
      </div>
    </section>

    <!-- KEY VALUES -->
    <section class="grid grid-cols-2 gap-3 mb-4">
      <div class="card p-4">
        <div class="text-[10px] uppercase font-black tracking-[.22em] mb-1 muted">Sonnenwind</div>
        <div class="text-3xl font-black mono" id="valSpd" style="color:var(--title)">--</div>
        <div class="text-[11px] muted2">km/s ‚Ä¢ h√∂her = besser</div>
      </div>
      <div class="card p-4">
        <div class="text-[10px] uppercase font-black tracking-[.22em] mb-1 muted">Magnetfeld (Bz)</div>
        <div class="text-3xl font-black mono" id="valBz" style="color:var(--title)">--</div>
        <div class="text-[11px] muted2">nT ‚Ä¢ je negativer, desto besser</div>
      </div>
    </section>

    <!-- WETTER & NACHT -->
    <section class="card p-4 mb-4">
      <div class="flex items-center justify-between mb-3">
        <div class="text-[10px] uppercase font-black tracking-[.25em] muted">Wetter & Nacht</div>
        <span class="badge" id="tagDayNight">‚Äî</span>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div class="card p-4">
          <div class="text-[10px] uppercase font-black tracking-[.22em] mb-2 muted">Bew√∂lkung</div>
          <div class="flex items-end gap-2">
            <div class="text-3xl font-black mono" id="valCloud" style="color:var(--title)">--</div>
            <div class="text-xl" id="icoCloud">‚òÅÔ∏è</div>
          </div>
          <div class="text-[12px] muted" id="valCloudTxt">‚Äî</div>
        </div>

        <div class="card p-4">
          <div class="text-[10px] uppercase font-black tracking-[.22em] mb-2 muted">Mond</div>
          <div class="flex items-end gap-2">
            <div class="text-3xl font-black mono" id="valMoon" style="color:var(--title)">--</div>
            <div class="text-xl" id="icoMoon">üåô</div>
          </div>
          <div class="text-[12px] muted" id="valMoonTxt">‚Äî</div>
        </div>
      </div>

      <div class="card p-4 mt-3">
        <div class="text-[10px] uppercase font-black tracking-[.22em] mb-2 muted">Sonnenzeiten (heute)</div>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div>
            <div class="muted text-[11px]">Sonnenuntergang</div>
            <div class="mono font-black" id="sunset" style="color:var(--title)">--:--</div>
          </div>
          <div>
            <div class="muted text-[11px]">Sonnenaufgang</div>
            <div class="mono font-black" id="sunrise" style="color:var(--title)">--:--</div>
          </div>
        </div>

        <!-- Diagnostics line for weather (so we see WHY it is empty) -->
        <div class="diag" id="wxDiag">‚Äî</div>
      </div>
    </section>

    <!-- CHARTS -->
    <section id="secCharts" class="card p-4 mb-4">
      <div class="flex items-center justify-between mb-3">
        <div class="text-[10px] uppercase font-black tracking-[.25em] muted">Bz & Speed (letzte ~2h)</div>
        <span class="badge">robust</span>
      </div>
      <div class="chart-wrap">
        <canvas id="chartMain"></canvas>
      </div>
    </section>

    <section class="card p-4 mb-4">
      <div class="flex items-center justify-between mb-3">
        <div class="text-[10px] uppercase font-black tracking-[.25em] muted">Kp Index (letzte 24h)</div>
        <span class="badge">gelb ab 5 ‚Ä¢ rot ab 7</span>
      </div>
      <div class="chart-wrap">
        <canvas id="chartKp"></canvas>
      </div>
      <div class="text-[11px] muted2 mt-2" id="kpInfo">‚Äî</div>
      <div class="diag" id="kpDiag">‚Äî</div>
    </section>

    <!-- MORE -->
    <section id="secMore" class="card p-4 mb-4">
      <div class="flex items-center justify-between mb-3">
        <div class="text-[10px] uppercase font-black tracking-[.25em] muted">GFZ Potsdam (Quicklook)</div>
        <span class="badge">oft schneller (EU)</span>
      </div>

      <div class="img-frame">
        <img id="gfzImg" alt="GFZ Quicklook" />
      </div>
    </section>

    <section class="card p-4 mb-4">
      <div class="flex items-center justify-between mb-3">
        <div class="text-[10px] uppercase font-black tracking-[.25em] muted">OVATION Aurora Oval (NOAA)</div>
        <button class="btn btn-ghost btn-mini" id="btnOvaRefresh">Refresh</button>
      </div>

      <div class="grid grid-cols-1 gap-3">
        <div class="img-frame">
          <img id="ovationGlobal" alt="NOAA Ovation Global" />
        </div>
        <div class="img-frame">
          <img id="ovationEurope" class="europe-crop" alt="NOAA Ovation Europa-Zoom" />
        </div>
      </div>

      <div class="flex items-center justify-between mt-3">
        <div class="text-[11px] muted">Praxis: Score + Wolken + dunkler Spot.</div>
        <span class="badge">refresh: <span id="ovaTime" class="mono">--:--</span></span>
      </div>

      <div id="ovationFallback" class="hidden mt-3 text-sm muted">
        OVATION gerade nicht erreichbar. Bitte sp√§ter refreshen.
      </div>
    </section>

    <!-- LINKS -->
    <section class="card p-4 mb-8">
      <div class="text-[10px] uppercase font-black tracking-[.25em] muted mb-3">Tipps & Tools</div>

      <div class="grid grid-cols-1 gap-2 text-sm">
        <a class="btn btn-ghost text-left justify-start" target="_blank" rel="noreferrer" href="https://www.lightpollutionmap.info/">
          üåë Dark Spot Finder
        </a>

        <a class="btn btn-ghost text-left justify-start" target="_blank" rel="noreferrer" href="https://www.windy.com/">
          ‚òÅÔ∏è Wolkencheck (Windy)
        </a>

        <a class="btn btn-ghost text-left justify-start" target="_blank" rel="noreferrer" href="https://services.swpc.noaa.gov/">
          üõ∞ NOAA Datenprodukte
        </a>

        <a class="btn btn-ghost text-left justify-start" target="_blank" rel="noreferrer" href="https://kp.gfz-potsdam.de/">
          üìà GFZ Kp & Quicklook
        </a>
      </div>

      <div class="text-center text-[10px] muted2 mt-4 tracking-[.35em] uppercase font-black">
        Aurora X ‚Ä¢ NOAA + GFZ + Open-Meteo + OSM ‚Ä¢ v6.1
      </div>
    </section>

  </div>

  <!-- Bottom Tabs -->
  <div class="tabs">
    <div class="tabs-inner">
      <div class="tab active" data-target="secNow">Jetzt</div>
      <div class="tab" data-target="secMap">Karte</div>
      <div class="tab" data-target="secCharts">Grafiken</div>
      <div class="tab" data-target="secMore">Mehr</div>
    </div>
  </div>

  <script>
/***********************
 *  ENDPOINTS (v6.1)
 ***********************/
const NOAA = {
  magSummary: "https://services.swpc.noaa.gov/products/summary/solar-wind-mag-field.json",
  spdSummary: "https://services.swpc.noaa.gov/products/summary/solar-wind-speed.json",
  mag1d: "https://services.swpc.noaa.gov/products/solar-wind/mag-1-day.json",
  plasma1d: "https://services.swpc.noaa.gov/products/solar-wind/plasma-1-day.json",

  // ‚úÖ FIX: stabiler Kp-Endpoint (der alte -1-day ist oft weg/kaputt)
  kp: "https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json",

  ovationNH: "https://services.swpc.noaa.gov/images/aurora-forecast-northern-hemisphere.jpg"
};

// Autocomplete: Photon (Komoot) meist CORS-freundlicher als Nominatim
const GEOCODE = {
  photon: (q) => `https://photon.komoot.io/api/?q=${encodeURIComponent(q)}&limit=6&lang=de`,
  nominatim: (q) => `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=6&accept-language=de&q=${encodeURIComponent(q)}`
};

const OPEN_METEO = {
  url: (lat, lon) =>
    `https://api.open-meteo.com/v1/forecast` +
    `?latitude=${encodeURIComponent(lat)}` +
    `&longitude=${encodeURIComponent(lon)}` +
    `&current=cloud_cover,is_day` +
    `&daily=sunrise,sunset,moon_illumination` +
    `&forecast_days=1` +
    `&timezone=auto`
};

function gfzQuicklookUrlYYYYMMDD(yyyy_mm_dd){
  return `https://kp.gfz-potsdam.de/fileadmin/kp-archiv/png/${yyyy_mm_dd}.png`;
}

/***********************
 *  STATE
 ***********************/
let currentLat = 50.83, currentLon = 12.92;
let chartMain = null, chartKp = null;
let map, marker, tileLayer;
let acTimer = null;

const $ = (id) => document.getElementById(id);

/***********************
 *  HELPERS
 ***********************/
function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

function safeNum(x){
  const n = Number.parseFloat(x);
  return Number.isFinite(n) ? n : null;
}

function fmtTimeLocal(date = new Date()){
  return date.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
}

function extractHHMM(t){
  if(!t) return null;
  const s = String(t);

  // ISO: YYYY-MM-DDTHH:MM...
  if(s.includes("T")){
    const d = new Date(s);
    if(!isNaN(d)) return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    const p = s.split("T")[1] || "";
    return p.slice(0,5);
  }
  // space: YYYY-MM-DD HH:MM:SS
  if(s.includes(" ")){
    const p = s.split(" ")[1] || "";
    return p.slice(0,5);
  }
  if(/^\d{2}:\d{2}/.test(s)) return s.slice(0,5);
  return null;
}

// ‚úÖ Fehler nicht mehr schlucken ‚Äì wir zeigen Diagnose (429/CORS/Timeout etc.)
function isErr(x){ return !!(x && typeof x === "object" && x.__error); }

async function fetchJson(url, timeoutMs = 12000){
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), timeoutMs);

  try{
    const res = await fetch(url, {
      cache: "no-store",
      signal: ctrl.signal,
      headers: { "Accept": "application/json" }
    });

    if(!res.ok){
      return { __error: true, url, status: res.status, statusText: res.statusText };
    }
    return await res.json();
  }catch(e){
    return { __error: true, url, message: String(e?.message || e) };
  }finally{
    clearTimeout(t);
  }
}

function lastValidRow(table, idx){
  if(!Array.isArray(table) || table.length < 2) return null;
  for(let i = table.length - 1; i >= 1; i--){
    const row = table[i];
    const v = safeNum(row?.[idx]);

    // ‚úÖ Zero-Gaps: 0 bei Solarwind ist oft "Gap" ‚Üí ignorieren (f√ºr Bz/Speed sinnvoll)
    // Aber Achtung: Bz kann real 0 sein. Wir werten 0 nur als Gap, wenn die Nachbarwerte nullig sind.
    if(v !== null){
      return row;
    }
  }
  return null;
}

function setDiag(el, text){
  const e = $(el);
  if(!e) return;
  e.textContent = text || "‚Äî";
}

function setWeatherUnavailable(reason){
  $("valCloud").textContent = "--";
  $("valCloudTxt").textContent = "Wetterdaten nicht verf√ºgbar";
  $("icoCloud").textContent = "‚òÅÔ∏è";

  $("valMoon").textContent = "--";
  $("valMoonTxt").textContent = "‚Äî";
  $("icoMoon").textContent = "üåô";

  $("sunrise").textContent = "--:--";
  $("sunset").textContent  = "--:--";

  $("tagDayNight").textContent = "‚Äî";
  $("uiNight").textContent = "‚Äî";
  $("chipCloud").textContent = "--";
  $("chipMoon").textContent = "--";

  setDiag("wxDiag", reason || "Wetter: keine Daten");
}

function clearGlow(el){
  el.classList.remove("glow-red","glow-yellow","glow-green");
}

/***********************
 *  THEME TOGGLE (system/light/dark)
 ***********************/
function getTheme(){
  return localStorage.getItem("aurora_theme") || "system";
}
function setTheme(t){
  document.documentElement.setAttribute("data-theme", t);
  localStorage.setItem("aurora_theme", t);
  updateMapStyleBadge();
}
function cycleTheme(){
  const cur = getTheme();
  const next = (cur === "system") ? "light" : (cur === "light" ? "dark" : "system");
  setTheme(next);
}

function isLightThemeEffective(){
  const t = document.documentElement.getAttribute("data-theme") || "system";
  if(t === "light") return true;
  if(t === "dark") return false;
  return window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
}

/***********************
 *  AUTOCOMPLETE
 ***********************/
function hideAc(){
  $("acList").classList.add("hidden");
  $("acList").innerHTML = "";
}

function showAc(items){
  const box = $("acList");
  box.innerHTML = "";
  if(!items || !items.length){ hideAc(); return; }

  items.forEach(it => {
    const div = document.createElement("div");
    div.className = "ac-item";
    div.textContent = it.label;
    div.onclick = () => {
      currentLat = it.lat;
      currentLon = it.lon;
      $("placeInput").value = it.short || it.label;
      hideAc();
      moveMap(currentLat, currentLon, true);
      updateAll();
    };
    box.appendChild(div);
  });
  box.classList.remove("hidden");
}

async function acSearch(q){
  const p = await fetchJson(GEOCODE.photon(q), 9000);
  if(p?.features?.length){
    return p.features.map(f => {
      const lat = f.geometry?.coordinates?.[1];
      const lon = f.geometry?.coordinates?.[0];
      const name = f.properties?.name || "";
      const city = f.properties?.city || f.properties?.state || "";
      const country = f.properties?.country || "";
      const label = [name, city, country].filter(Boolean).join(", ");
      return {
        label: label || f.properties?.label || q,
        short: name || city || q,
        lat: Number(lat),
        lon: Number(lon)
      };
    }).filter(x => Number.isFinite(x.lat) && Number.isFinite(x.lon));
  }

  const n = await fetchJson(GEOCODE.nominatim(q), 9000);
  if(Array.isArray(n) && n.length){
    return n.map(d => ({
      label: d.display_name,
      short: (d.display_name || "").split(",")[0] || q,
      lat: Number(d.lat),
      lon: Number(d.lon)
    })).filter(x => Number.isFinite(x.lat) && Number.isFinite(x.lon));
  }

  return [];
}

/***********************
 *  MAP
 ***********************/
function moveMap(lat, lon, animate=false){
  $("uiLat").textContent = Number(lat).toFixed(2);
  $("uiLon").textContent = Number(lon).toFixed(2);

  if(map && marker){
    marker.setLatLng([lat, lon]);
    map.setView([lat, lon], map.getZoom(), { animate });
  }
}

function updateMapStyleBadge(){
  const light = isLightThemeEffective();
  $("mapModeBadge").textContent = light ? "Day Map" : "Night Map";

  if(!map) return;

  const url = light
    ? "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png"
    : "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png";

  if(tileLayer) tileLayer.setUrl(url);
}

function setupMap(){
  map = L.map("map", { zoomControl: true }).setView([currentLat, currentLon], 9);

  const light = isLightThemeEffective();
  const url = light
    ? "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png"
    : "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png";

  tileLayer = L.tileLayer(url, {
    attribution: '&copy; OpenStreetMap &copy; CARTO',
    subdomains: "abcd",
    maxZoom: 20
  }).addTo(map);

  marker = L.marker([currentLat, currentLon], { draggable: true }).addTo(map);
  marker.on("dragend", () => {
    const p = marker.getLatLng();
    currentLat = p.lat;
    currentLon = p.lng;
    moveMap(currentLat, currentLon);
    updateAll();
  });

  updateMapStyleBadge();
}

/***********************
 *  SCORE + DECISION
 ***********************/
function computeAuroraScore({ bz, spd, kp, cloud, moonIllum, isNight }){
  let score = 0;

  // Kp weight (0..9 => 0..70)
  if(kp !== null) score += clamp((kp / 9) * 70, 0, 70);

  // Bz bonus (0..-20 => 0..20)
  if(bz !== null){
    score += clamp(((-bz) / 20) * 20, 0, 20);
    if(bz <= -10) score += 6;
  }

  // Speed bonus (300..800 => 0..18)
  if(spd !== null){
    score += clamp(((spd - 300) / 500) * 18, 0, 18);
    if(spd >= 600) score += 4;
  }

  // Day penalty (wenn wir isNight nicht wissen, d√§mpfen wir NICHT)
  if(isNight === false) score *= 0.22;

  // Clouds reduce visibility (wenn cloud unbekannt ‚Üí kein Abzug)
  if(cloud !== null){
    const clearFactor = clamp((100 - cloud) / 100, 0, 1);
    score *= clearFactor;
  }

  // Moon penalty (0..~18)
  if(moonIllum !== null){
    const pen = clamp((moonIllum / 100) * 18, 0, 18);
    score -= pen;
  }

  score = Math.round(clamp(score, 0, 100));

  const why = [];
  if(isNight === false) why.push("Tag/D√§mmerung");
  else if(isNight === true) why.push("Nacht");
  else why.push("Dunkelheit ?");

  if(kp !== null) why.push(`Kp ${kp.toFixed(1)}`);
  if(bz !== null) why.push(`Bz ${bz.toFixed(1)} nT`);
  if(spd !== null) why.push(`Speed ${Math.round(spd)} km/s`);
  if(cloud !== null) why.push(`${Math.round(cloud)}% Wolken`);
  if(moonIllum !== null) why.push(`${Math.round(moonIllum)}% Mond`);

  return { score, why: why.join(" ‚Ä¢ ") };
}

function decideStatus({ score, bz, spd, cloud, isNight }){
  const statusEl = $("mainStatus");
  statusEl.className = "text-6xl font-black tracking-tight";
  clearGlow(statusEl);

  const strong = (bz !== null && spd !== null && bz <= -10 && spd >= 520);
  const veryClear = (cloud !== null && cloud <= 30);
  const okNight = (isNight !== false); // wenn unknown, lassen wir's gelten

  if(okNight && (score >= 70 || (strong && veryClear))){
    statusEl.textContent = "ALARM";
    statusEl.classList.add("glow-red");
    $("mainRec").textContent = `RAUS! Richtung Norden, Langzeitbelichtung. ${cloud !== null ? (cloud <= 30 ? "Wolken gut." : "Wolken pr√ºfen.") : ""}`;
    return;
  }

  if(okNight && score >= 40){
    statusEl.textContent = "CHANCE";
    statusEl.classList.add("glow-yellow");
    $("mainRec").textContent = "Beobachten! Kamera bereit halten, Testshots machen (Norden).";
    return;
  }

  statusEl.textContent = "RUHIG";
  statusEl.style.color = "var(--title)";
  statusEl.style.opacity = "0.55";
  $("mainRec").textContent = okNight ? "Aktuell eher nichts. Sp√§ter nochmal checken." : "Der Himmel ist (noch) zu hell. Sp√§ter nochmal checken.";
}

function updateScoreUI(score, why){
  $("uiScore").textContent = score;
  $("uiScoreWhy").textContent = why || "‚Äî";
  $("scoreBar").style.width = `${score}%`;

  const bar = $("scoreBar");
  if(score >= 70) bar.style.background = "rgba(239,68,68,.85)";
  else if(score >= 40) bar.style.background = "rgba(245,158,11,.85)";
  else bar.style.background = "rgba(34,197,94,.75)";
}

/***********************
 *  CHARTS
 ***********************/
function buildChartBzSpeed(labels, bzArr, spdArr){
  const ctx = $("chartMain").getContext("2d");
  if(chartMain) chartMain.destroy();

  chartMain = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        { label: "Bz (nT)", data: bzArr, borderColor: "#3b82f6", borderWidth: 2, pointRadius: 0, tension: .35, yAxisID: "y" },
        { label: "Speed (km/s)", data: spdArr, borderColor: "#ef4444", borderWidth: 2, pointRadius: 0, tension: .35, yAxisID: "y1" }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: {
        legend: { display: true, labels: { color: "rgba(127,127,127,.95)", boxWidth: 18 } },
        tooltip: { enabled: true }
      },
      scales: {
        x: { grid: { color: "rgba(127,127,127,.18)" }, ticks: { color: "rgba(127,127,127,.85)", maxTicksLimit: 8 } },
        y: { position: "left", grid: { color: "rgba(127,127,127,.18)" }, ticks: { color: "rgba(127,127,127,.85)" } },
        y1:{ position: "right", grid: { display:false }, ticks: { color: "rgba(127,127,127,.85)" } }
      }
    }
  });
}

function kpColor(v){
  if(v === null) return "rgba(127,127,127,.18)";
  if(v >= 7) return "rgba(239,68,68,.85)";
  if(v >= 5) return "rgba(245,158,11,.85)";
  return "rgba(34,197,94,.65)";
}

function buildChartKp(labels, values){
  const ctx = $("chartKp").getContext("2d");
  if(chartKp) chartKp.destroy();

  chartKp = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Kp",
        data: values,
        backgroundColor: values.map(kpColor),
        borderWidth: 0,
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: { legend: { display: false }, tooltip: { enabled: true } },
      scales: {
        x: { grid: { color: "rgba(127,127,127,.18)" }, ticks: { color: "rgba(127,127,127,.85)", maxTicksLimit: 10 } },
        y: { suggestedMin: 0, suggestedMax: 9, grid: { color: "rgba(127,127,127,.18)" }, ticks: { color: "rgba(127,127,127,.85)" } }
      }
    }
  });
}

/***********************
 *  OVATION + GFZ
 ***********************/
function refreshOvation(){
  $("ovationFallback").classList.add("hidden");
  const ts = Date.now();
  const src = `${NOAA.ovationNH}?ts=${ts}`;

  const g = $("ovationGlobal");
  const e = $("ovationEurope");

  g.onerror = () => $("ovationFallback").classList.remove("hidden");
  e.onerror = () => $("ovationFallback").classList.remove("hidden");

  g.src = src;
  e.src = src;

  $("ovaTime").textContent = fmtTimeLocal();
}

function refreshGFZ(){
  const d = new Date();
  const yyyy_mm_dd = d.toISOString().slice(0,10);
  const url = gfzQuicklookUrlYYYYMMDD(yyyy_mm_dd) + `?ts=${Date.now()}`;
  const img = $("gfzImg");
  img.onerror = () => {
    img.removeAttribute("src");
    img.alt = "GFZ Quicklook aktuell nicht erreichbar.";
  };
  img.src = url;
}

/***********************
 *  RENDER CHARTS
 ***********************/
function renderTrendChart(mag, plasma){
  if(!Array.isArray(mag) || !Array.isArray(plasma)) return;

  const magSlice = mag.slice(-160);
  const plSlice  = plasma.slice(-160);

  const labels=[], bzArr=[], spdArr=[];
  const len = Math.min(magSlice.length, plSlice.length);

  for(let i=0; i<len; i++){
    const m = magSlice[i];
    const p = plSlice[i];

    const t = extractHHMM(m?.[0]) || extractHHMM(p?.[0]);
    if(!t) continue;

    const bzVal = safeNum(m?.[3]);
    const spVal = safeNum(p?.[2]);

    labels.push(t);
    bzArr.push(bzVal !== null ? bzVal : null);
    spdArr.push(spVal !== null ? spVal : null);
  }

  const maxPoints = 80;
  const cut = labels.length > maxPoints ? labels.length - maxPoints : 0;
  buildChartBzSpeed(labels.slice(cut), bzArr.slice(cut), spdArr.slice(cut));
}

function renderKpChart(kpTable){
  // NOAA Kp: meistens Array (Header + Daten)
  if(!Array.isArray(kpTable) || kpTable.length < 3){
    $("kpInfo").textContent = "Kp: keine Daten (NOAA nicht erreichbar).";
    return { lastKp: null, diag: "Kp: keine Daten" };
  }

  const rows = kpTable.slice(1).slice(-32); // mehr reinholen, wir cutten sp√§ter
  const labels=[], values=[];
  let validCount = 0;

  rows.forEach(r => {
    // Format ist i.d.R: [time_tag, kp, ...] ‚Äì kp liegt an Index 1
    const t = extractHHMM(r?.[0]);
    const v = safeNum(r?.[1]);
    if(!t) return;

    labels.push(t);
    values.push(v !== null ? v : null);
    if(v !== null) validCount++;
  });

  const maxBars = 12;
  const cut = labels.length > maxBars ? labels.length - maxBars : 0;
  const L = labels.slice(cut);
  const V = values.slice(cut);

  buildChartKp(L, V);

  const lastV = [...values].reverse().find(x => x !== null);
  $("kpInfo").textContent = (validCount > 0)
    ? `Letzter Kp-Wert: ${lastV !== undefined ? lastV : "‚Äî"}`
    : "Kp: Daten kamen an, aber ohne Werte (NOAA liefert teils L√ºcken).";

  return {
    lastKp: (typeof lastV === "number" ? lastV : null),
    diag: `Kp ok ‚Ä¢ Samples: ${validCount}/${values.length}`
  };
}

/***********************
 *  MAIN UPDATE PIPELINE
 ***********************/
function setLiveBadge(text, state){
  const b = $("badgeLive");
  b.textContent = text;
  clearGlow(b);
  b.style.opacity = "1";

  if(state === "ok") b.classList.add("glow-green");
  if(state === "warn") b.classList.add("glow-yellow");
  if(state === "err") b.classList.add("glow-red");
}

function bzTrendArrowFromSeries(mag1d){
  // klein & robust: verglichen letzte 2 g√ºltige Bz-Werte
  if(!Array.isArray(mag1d) || mag1d.length < 6) return "";
  let last = null, prev = null;

  for(let i = mag1d.length - 1; i >= 1; i--){
    const v = safeNum(mag1d[i]?.[3]);
    if(v === null) continue;
    if(last === null){ last = v; continue; }
    prev = v;
    break;
  }
  if(last === null || prev === null) return "";
  // Bz negativer = besser. Wir zeigen Pfeil Richtung "negativer" (fallend) als ‚ÜòÔ∏é
  if(last < prev) return "‚ÜòÔ∏é";
  if(last > prev) return "‚ÜóÔ∏é";
  return "‚Üí";
}

async function updateAll(){
  setLiveBadge("lade‚Ä¶");

  moveMap(currentLat, currentLon);

  // 1) Fast summaries (Bz/Speed)
  const [magSum, spdSum] = await Promise.all([
    fetchJson(NOAA.magSummary, 9000),
    fetchJson(NOAA.spdSummary, 9000)
  ]);

  let bz = null, spd = null;

  if(!isErr(magSum) && magSum && typeof magSum === "object"){
    bz = safeNum(magSum.bz ?? magSum.Bz ?? magSum.bz_gsm);
  }
  if(!isErr(spdSum) && spdSum && typeof spdSum === "object"){
    spd = safeNum(spdSum.wind_speed ?? spdSum.speed ?? spdSum.WindSpeed);
  }

  // 2) Trend tables + Kp
  const [mag1d, plasma1d, kpTable] = await Promise.all([
    fetchJson(NOAA.mag1d, 12000),
    fetchJson(NOAA.plasma1d, 12000),
    fetchJson(NOAA.kp, 12000)
  ]);

  // Kp: Diagnose
  if(isErr(kpTable)){
    setDiag("kpDiag", `Kp Fehler: ${kpTable.status || ""} ${kpTable.statusText || kpTable.message || ""}`.trim());
    $("kpInfo").textContent = "Kp: keine Daten (NOAA nicht erreichbar).";
  }else{
    setDiag("kpDiag", "Kp: ok");
  }

  // fallback bz/spd from tables
  if(bz === null && !isErr(mag1d) && Array.isArray(mag1d)){
    const last = lastValidRow(mag1d, 3);
    bz = last ? safeNum(last[3]) : null;
  }
  if(spd === null && !isErr(plasma1d) && Array.isArray(plasma1d)){
    const last = lastValidRow(plasma1d, 2);
    spd = last ? safeNum(last[2]) : null;
  }

  // Trend arrow
  const bzTrend = (!isErr(mag1d) ? bzTrendArrowFromSeries(mag1d) : "");
  $("chipBzTrend").textContent = bzTrend ? ` ${bzTrend}` : "";

  // Kp last
  let kp = null;
  if(!isErr(kpTable) && Array.isArray(kpTable)){
    const last = lastValidRow(kpTable, 1);
    kp = last ? safeNum(last[1]) : null;
  }

  // 3) Weather (robust + fallback)
  let cloud = null, moonIllum = null, isNight = null;
  let wx = await fetchJson(OPEN_METEO.url(currentLat, currentLon), 14000);

  // fallback attempt (hourly cloud)
  if(isErr(wx)){
    const fallbackUrl =
      `https://api.open-meteo.com/v1/forecast` +
      `?latitude=${encodeURIComponent(currentLat)}` +
      `&longitude=${encodeURIComponent(currentLon)}` +
      `&hourly=cloud_cover` +
      `&daily=sunrise,sunset,moon_illumination` +
      `&forecast_days=1` +
      `&timezone=auto`;
    wx = await fetchJson(fallbackUrl, 14000);
  }

  if(isErr(wx)){
    setWeatherUnavailable(`Wetter Fehler: ${wx.status || ""} ${wx.statusText || wx.message || ""}`.trim());
  }else{
    // Cloud
    cloud = safeNum(wx?.current?.cloud_cover);
    if(cloud === null && Array.isArray(wx?.hourly?.cloud_cover)){
      cloud = safeNum(wx.hourly.cloud_cover[0]);
    }

    // Day/Night
    const isDay = wx?.current?.is_day; // 0/1 oder undefined
    isNight = (isDay === 0) ? true : (isDay === 1 ? false : null);

    // sunrise/sunset
    const sunriseISO = wx?.daily?.sunrise?.[0] ?? null;
    const sunsetISO  = wx?.daily?.sunset?.[0] ?? null;
    const sunrise = extractHHMM(sunriseISO);
    const sunset  = extractHHMM(sunsetISO);

    // moon illum
    if(Array.isArray(wx?.daily?.moon_illumination)){
      moonIllum = safeNum(wx.daily.moon_illumination[0]);
      if(moonIllum !== null && moonIllum <= 1.01) moonIllum *= 100;
      moonIllum = clamp(moonIllum, 0, 100);
    }

    // UI: chips
    $("chipCloud").textContent = (cloud !== null) ? `${Math.round(cloud)}%` : "--";
    $("chipMoon").textContent  = (moonIllum !== null) ? `${Math.round(moonIllum)}%` : "--";

    // UI: weather cards
    $("valCloud").textContent = (cloud !== null) ? `${Math.round(cloud)}%` : "--";
    $("valMoon").textContent  = (moonIllum !== null) ? `${Math.round(moonIllum)}%` : "--";

    if(cloud === null){
      $("valCloudTxt").textContent = "‚Äî";
      $("icoCloud").textContent = "‚òÅÔ∏è";
    }else if(cloud > 80){
      $("valCloudTxt").textContent = "Bew√∂lkt";
      $("icoCloud").textContent = "‚òÅÔ∏è";
    }else if(cloud > 35){
      $("valCloudTxt").textContent = "Teils klar";
      $("icoCloud").textContent = "‚õÖ";
    }else{
      $("valCloudTxt").textContent = "Klar";
      $("icoCloud").textContent = "üåô";
    }

    if(moonIllum === null){
      $("valMoonTxt").textContent = "‚Äî";
      $("icoMoon").textContent = "üåô";
    }else if(moonIllum > 75){
      $("valMoonTxt").textContent = "Hell";
      $("icoMoon").textContent = "üåï";
    }else if(moonIllum > 35){
      $("valMoonTxt").textContent = "Mittel";
      $("icoMoon").textContent = "üåì";
    }else{
      $("valMoonTxt").textContent = "Dunkel (top)";
      $("icoMoon").textContent = "üåô";
    }

    $("sunrise").textContent = sunrise || "--:--";
    $("sunset").textContent  = sunset  || "--:--";

    if(isNight === true){
      $("uiNight").textContent = "Nacht";
      $("tagDayNight").textContent = "Nacht";
    }else if(isNight === false){
      $("uiNight").textContent = "Tag/D√§mmerung";
      $("tagDayNight").textContent = "Tag/D√§mmerung";
    }else{
      $("uiNight").textContent = "‚Äî";
      $("tagDayNight").textContent = "‚Äî";
    }

    // Diagnostics
    setDiag("wxDiag", "Wetter: ok");
  }

  // 4) Fill solarwind UI
  $("valBz").textContent = (bz !== null) ? bz.toFixed(1) : "--";
  $("valSpd").textContent = (spd !== null) ? Math.round(spd) : "--";

  $("chipBz").textContent = (bz !== null) ? bz.toFixed(1) : "--";
  $("chipSpd").textContent = (spd !== null) ? Math.round(spd) : "--";
  $("chipKp").textContent = (kp !== null) ? kp.toFixed(1) : "--";

  // 5) Update time + live badge
  $("uiUpdated").textContent = fmtTimeLocal();

  const liveOk = (bz !== null || spd !== null || kp !== null || cloud !== null);
  setLiveBadge(liveOk ? "live" : "offline", liveOk ? "ok" : "err");

  // 6) Score + decision
  const scorePack = computeAuroraScore({ bz, spd, kp, cloud, moonIllum, isNight });
  updateScoreUI(scorePack.score, scorePack.why);
  decideStatus({ score: scorePack.score, bz, spd, cloud, isNight });

  // 7) Charts render
  if(!isErr(mag1d) && !isErr(plasma1d)){
    renderTrendChart(mag1d, plasma1d);
  }

  if(!isErr(kpTable)){
    const { diag } = renderKpChart(kpTable);
    setDiag("kpDiag", diag || "Kp: ok");
  }

  // 8) Images
  refreshGFZ();
  refreshOvation();
}

/***********************
 *  EVENTS
 ***********************/
$("btnUpdate").addEventListener("click", () => updateAll());

$("btnGPS").addEventListener("click", () => {
  if(!navigator.geolocation){
    alert("GPS nicht verf√ºgbar.");
    return;
  }
  setLiveBadge("gps‚Ä¶", "warn");
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      currentLat = pos.coords.latitude;
      currentLon = pos.coords.longitude;
      $("placeInput").value = "";
      hideAc();
      moveMap(currentLat, currentLon, true);
      updateAll();
    },
    () => {
      alert("Ortung abgelehnt oder fehlgeschlagen.");
      setLiveBadge("offline", "err");
    },
    { enableHighAccuracy: true, timeout: 10000 }
  );
});

$("btnOvaRefresh").addEventListener("click", () => refreshOvation());
$("btnTheme").addEventListener("click", () => {
  cycleTheme();
  updateMapStyleBadge();
});

$("placeInput").addEventListener("input", (e) => {
  const q = e.target.value.trim();
  clearTimeout(acTimer);

  if(q.length < 3){
    hideAc();
    return;
  }
  acTimer = setTimeout(async () => {
    const items = await acSearch(q);
    showAc(items);
  }, 280);
});

document.addEventListener("click", (e) => {
  const ac = $("placeInput");
  const list = $("acList");
  if(e.target !== ac && !list.contains(e.target)) hideAc();
});

// Bottom tabs scroll
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    const id = tab.getAttribute("data-target");
    const el = document.getElementById(id);
    if(el) el.scrollIntoView({ behavior:"smooth", block:"start" });
  });
});

/***********************
 *  INIT
 ***********************/
function init(){
  // kleine Chips (keine √ºberfl√ºssigen W√∂rter)
  $("chipOverlay").textContent = "OVAL";
  $("chipNightline").textContent = "NACHT";

  setTheme(getTheme());
  moveMap(currentLat, currentLon);
  setupMap();

  refreshGFZ();
  refreshOvation();

  updateAll();
  setInterval(updateAll, 60000);

  // system theme changes while on "system"
  if(window.matchMedia){
    window.matchMedia("(prefers-color-scheme: light)").addEventListener("change", () => {
      if(getTheme() === "system") updateMapStyleBadge();
    });
  }
}

init();
</script>

</body>
</html>
