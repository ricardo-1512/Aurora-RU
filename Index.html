<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AURORA X ‚Äî Live Entscheidung</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{ --bg:#050505; }
    body{ background:var(--bg); color:#fff; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    .glass{
      background: radial-gradient(1200px 500px at 20% -10%, rgba(34,197,94,.20), transparent 55%),
                  radial-gradient(900px 450px at 90% 0%, rgba(59,130,246,.18), transparent 55%),
                  linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.08);
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.025));
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      box-shadow: 0 18px 55px rgba(0,0,0,.55);
    }
    .badge{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      border-radius:999px;
      padding:.25rem .55rem;
      font-size:10px;
      letter-spacing:.2em;
      text-transform: uppercase;
      color: rgba(255,255,255,.65);
      white-space: nowrap;
    }
    .glow-red{ color:#ef4444; text-shadow: 0 0 25px rgba(239, 68, 68, .55); }
    .glow-yellow{ color:#f59e0b; text-shadow: 0 0 25px rgba(245, 158, 11, .45); }
    .glow-green{ color:#22c55e; text-shadow: 0 0 25px rgba(34, 197, 94, .50); }

    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      transition: transform .12s ease, background .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); }
    .btn-primary{
      background: rgba(34,197,94,.85);
      border-color: rgba(34,197,94,.35);
      color:#06210f;
    }
    .btn-primary:hover{ background: rgba(34,197,94,.95); }

    .input{
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 10px;
      padding: 10px 12px;
      color: #fff;
      outline: none;
    }
    .input:focus{ border-color: rgba(34,197,94,.45); box-shadow: 0 0 0 4px rgba(34,197,94,.12); }

    /* charts: fixed height, no infinite grow */
    .chart-wrap{ height: 190px; width:100%; position:relative; }
    @media (min-width: 768px){ .chart-wrap{ height: 220px; } }
    .chart-wrap.kp{ height: 170px; }
    canvas{
      width:100% !important;
      height:100% !important;
      display:block;
      background: rgba(0,0,0,.15);
      border:1px solid rgba(255,255,255,.06);
      border-radius: 16px;
    }

    #map{ height: 220px; border-radius: 16px; overflow:hidden; border:1px solid rgba(255,255,255,.08); }

    .ov-wrap{ position:relative; border-radius:16px; overflow:hidden; border:1px solid rgba(255,255,255,.08); }
    .ov-overlay{
      position:absolute; inset:auto 10px 10px 10px;
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }
    .tiny{ font-size:11px; color: rgba(255,255,255,.65); }
    a{ color: rgba(255,255,255,.75); }
    a:hover{ color:#fff; }
  </style>
</head>

<body class="p-4 md:p-8">
  <div class="max-w-3xl mx-auto">

    <!-- Header -->
    <div class="glass rounded-2xl p-4 md:p-5 mb-4">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <div class="flex items-baseline gap-2">
            <h1 class="text-xl md:text-2xl font-black tracking-tight">AURORA <span class="text-green-400">X</span></h1>
            <span class="badge" id="dataBadge">LIVE</span>
          </div>
          <div class="text-[11px] text-white/55 uppercase tracking-[0.25em] mt-1">
            Entscheidung f√ºr ‚ÄûGeh ich raus oder nicht?‚Äú
          </div>
          <div id="locationStatus" class="text-[11px] text-white/55 mt-2">Standort: <span class="text-white/80">Chemnitz</span></div>
        </div>

        <div class="w-full md:w-[56%]">
          <div class="flex gap-2">
            <input id="placeInput" class="input w-full text-sm" placeholder="Ort suchen (z. B. Chemnitz, Erzgebirge, ‚Ä¶)" autocomplete="off">
            <button class="btn btn-primary px-4 rounded-xl text-xs font-bold uppercase" id="btnUpdate">Update</button>
            <button class="btn px-3 rounded-xl" id="btnGPS" title="Meinen Standort nutzen">üìç</button>
          </div>

          <div id="suggestions" class="mt-2 hidden card p-2"></div>

          <div class="mt-2 flex items-center justify-between text-[10px] text-white/45 uppercase tracking-widest">
            <div>Lat: <span id="latText" class="text-white/70 mono">50.83</span> ‚Ä¢ Lon: <span id="lonText" class="text-white/70 mono">12.92</span></div>
            <div>Letztes Update: <span id="updatedAt" class="text-white/70 mono">--:--</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚úÖ MAP DIRECTLY UNDER LOCATION (makes more sense) -->
    <div class="card p-4 mb-6">
      <div class="flex items-center justify-between mb-3">
        <div class="text-[10px] uppercase tracking-[0.25em] text-white/45 font-bold">Standort-Pin ziehen</div>
        <div class="badge">draggable</div>
      </div>
      <div id="map"></div>
      <div class="text-[11px] text-white/55 mt-3">Tipp: Zieh den Pin aufs Land raus (dunkler) und check Wolken dort.</div>
    </div>

    <!-- Main decision -->
    <div class="card p-6 text-center mb-6">
      <div class="badge inline-block mb-4">Wahrscheinlichkeit</div>
      <div id="mainStatus" class="text-5xl md:text-6xl font-black tracking-tight mono text-white/25">ANALYSE</div>
      <p id="mainRec" class="text-sm md:text-base text-white/60 italic mt-4 px-2">Verbinde mit Satelliten-Daten‚Ä¶</p>

      <div class="mt-5 flex flex-wrap justify-center gap-2 text-[11px] text-white/60">
        <span class="badge">Bz: <span id="bzChip" class="text-white/80 mono">--</span></span>
        <span class="badge">Speed: <span id="spdChip" class="text-white/80 mono">--</span></span>
        <span class="badge">Kp: <span id="kpChip" class="text-white/80 mono">--</span></span>
        <span class="badge">Wolken: <span id="cloudChip" class="text-white/80 mono">--</span></span>
        <span class="badge">Mond: <span id="moonChip" class="text-white/80 mono">--</span></span>
      </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="card p-4">
        <div class="text-[10px] uppercase tracking-[0.25em] text-white/45 font-bold mb-2">Magnetfeld (Bz)</div>
        <div class="text-3xl font-black mono" id="bzVal">--</div>
        <div class="mt-3 h-2 bg-white/10 rounded-full overflow-hidden">
          <div id="bzBar" class="h-full bg-blue-500" style="width:50%"></div>
        </div>
        <div class="text-[11px] text-white/55 mt-3">Je negativer (s√ºdlicher), desto besser f√ºrs Oval.</div>
      </div>

      <div class="card p-4">
        <div class="text-[10px] uppercase tracking-[0.25em] text-white/45 font-bold mb-2">Sonnenwind Speed</div>
        <div class="text-3xl font-black mono"><span id="speedVal">--</span> <span class="text-base text-white/40">km/s</span></div>
        <div class="text-[11px] text-white/55 mt-3">Hohe Speed + negativer Bz = ‚ÄûChef‚Äôs Kiss‚Äú.</div>
      </div>

      <div class="card p-4">
        <div class="text-[10px] uppercase tracking-[0.25em] text-white/45 font-bold mb-2">Wetter & Mond</div>
        <div class="text-3xl font-black mono" id="cloudVal">--</div>
        <div class="text-[11px] text-white/70 mt-2" id="moonVal">Mond: --</div>
        <div class="text-[11px] text-white/55 mt-2">Wolken killen alles ‚Äì Mond ist ‚ÄûLichtverschmutzung deluxe‚Äú.</div>
      </div>
    </div>

    <!-- OVATION -->
    <div class="card p-4 mb-6">
      <div class="flex items-center justify-between mb-3">
        <div class="text-[10px] uppercase tracking-[0.25em] text-white/45 font-bold">OVATION Aurora Oval (NOAA, 30‚Äì90 min)</div>
        <div class="badge">OVATION</div>
      </div>
      <div class="ov-wrap">
        <img id="ovationImg" alt="NOAA Ovation Aurora Forecast" class="w-full block"
             src="https://services.swpc.noaa.gov/images/animations/ovation-north/latest.jpg">
        <div class="ov-overlay">
          <span class="badge">Live Map</span>
          <span class="badge">Refresh: <span id="ovTime" class="mono">--:--</span></span>
        </div>
      </div>
      <div class="mt-3 tiny">Oval = grobe Nowcast-Wahrscheinlichkeit. Praxis bleibt: Bz + Speed + Wolken + dunkler Spot.</div>
    </div>

    <!-- Graphs -->
    <div class="grid grid-cols-1 gap-4 mb-6">
      <div class="card p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-[10px] uppercase tracking-[0.25em] text-white/45 font-bold">Bz & Speed (letzte Stunden)</div>
          <div class="badge">NOAA tables ‚Ä¢ filtered</div>
        </div>
        <div class="chart-wrap">
          <canvas id="chartBzSpeed"></canvas>
        </div>
      </div>

      <div class="card p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-[10px] uppercase tracking-[0.25em] text-white/45 font-bold">Kp Index (letzte 24h)</div>
          <div class="badge">NOAA Kp</div>
        </div>
        <div class="chart-wrap kp">
          <canvas id="chartKp"></canvas>
        </div>
      </div>
    </div>

    <!-- Links -->
    <div class="card p-4">
      <div class="text-[10px] uppercase tracking-[0.25em] text-white/45 font-bold mb-3">Praktische Links</div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
        <a class="btn rounded-xl px-3 py-2" target="_blank" rel="noopener" href="https://www.swpc.noaa.gov/">NOAA Space Weather (SWPC)</a>
        <a class="btn rounded-xl px-3 py-2" target="_blank" rel="noopener" href="https://services.swpc.noaa.gov/products/">NOAA Data Products (JSON)</a>
        <a class="btn rounded-xl px-3 py-2" target="_blank" rel="noopener" href="https://www.spaceweatherlive.com/">SpaceWeatherLive (√úbersicht)</a>
        <a class="btn rounded-xl px-3 py-2" target="_blank" rel="noopener" href="https://www.lightpollutionmap.info/">Light Pollution Map (Dunkle Spots)</a>
        <a class="btn rounded-xl px-3 py-2" target="_blank" rel="noopener" href="https://www.windy.com/">Windy (Wolken/Modelle)</a>
        <a class="btn rounded-xl px-3 py-2" target="_blank" rel="noopener" href="https://www.cleardarksky.com/">Clear Dark Sky (Astro)</a>
      </div>
      <div class="text-[9px] text-white/30 uppercase tracking-[0.4em] font-bold mt-6 text-center">
        Aurora X ‚Ä¢ tables aligned by timestamp ‚Ä¢ v7
      </div>
    </div>

  </div>

  <script>
    let currentLat = 50.83;
    let currentLon = 12.92;
    let map, marker, tileLayer;
    let chartBzSpeed, chartKp;

    const $ = (id) => document.getElementById(id);

    function nowHHMM(){
      return new Date().toLocaleTimeString("de-DE", {hour:"2-digit", minute:"2-digit"});
    }
    function safeNum(x){
      const n = parseFloat(x);
      return Number.isFinite(n) ? n : null;
    }
    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    // ‚úÖ use seconds to avoid duplicate X labels (fixes vertical stripes)
    function toHHMMSSfromISO(iso){
      if(!iso) return "";
      const t = iso.split(" ")[1] || "";
      return t.slice(0,8); // HH:MM:SS
    }
    function toHHMMfromISO(iso){
      if(!iso) return "";
      const t = iso.split(" ")[1] || "";
      return t.slice(0,5);
    }

    async function fetchJson(url, timeoutMs=12000){
      const controller = new AbortController();
      const t = setTimeout(()=>controller.abort(), timeoutMs);
      try{
        const res = await fetch(url, {cache:"no-store", signal: controller.signal});
        if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
        return await res.json();
      } finally { clearTimeout(t); }
    }

    // Moon (local)
    function moonInfo(date=new Date()){
      const knownNewMoon = Date.UTC(2000,0,6,18,14,0);
      const synodicMonth = 29.530588853;
      const days = (date.getTime()-knownNewMoon)/86400000;
      const phase = (days % synodicMonth + synodicMonth) % synodicMonth;
      const frac = phase/synodicMonth;
      const illumination = (1 - Math.cos(2*Math.PI*frac))/2;
      const illumPct = Math.round(illumination*100);

      let name="Neumond", emoji="üåë";
      if (frac < 0.03 || frac > 0.97) { name="Neumond"; emoji="üåë"; }
      else if (frac < 0.22) { name="Zunehmend"; emoji="üåí"; }
      else if (frac < 0.28) { name="Erstes Viertel"; emoji="üåì"; }
      else if (frac < 0.47) { name="Zunehmend"; emoji="üåî"; }
      else if (frac < 0.53) { name="Vollmond"; emoji="üåï"; }
      else if (frac < 0.72) { name="Abnehmend"; emoji="üåñ"; }
      else if (frac < 0.78) { name="Letztes Viertel"; emoji="üåó"; }
      else { name="Abnehmend"; emoji="üåò"; }

      const penalty = illumPct >= 70 ? "hell" : (illumPct >= 35 ? "mittel" : "dunkel");
      return { illumPct, name, emoji, penalty };
    }

    // UI
    function setDecisionUI(level, rec){
      const el = $("mainStatus");
      const recEl = $("mainRec");
      el.className = "text-5xl md:text-6xl font-black tracking-tight mono";
      if(level==="ALARM"){ el.textContent="ALARM"; el.classList.add("glow-red"); }
      else if(level==="CHANCE"){ el.textContent="CHANCE"; el.classList.add("glow-yellow"); }
      else if(level==="WATCH"){ el.textContent="WATCH"; el.classList.add("glow-green"); }
      else { el.textContent="RUHIG"; el.classList.add("text-white/25"); }
      recEl.textContent = rec || "‚Äî";
    }

    function setBzBar(bz){
      const bar = $("bzBar");
      if(bz===null){
        bar.style.width="50%";
        bar.className="h-full bg-blue-500";
        return;
      }
      const pct = Math.round(((clamp(bz,-20,20)+20)/40)*100);
      bar.style.width = pct + "%";
      bar.className="h-full";
      if(bz<=-12) bar.classList.add("bg-red-500");
      else if(bz<=-5) bar.classList.add("bg-yellow-500");
      else if(bz<=0) bar.classList.add("bg-blue-500");
      else bar.classList.add("bg-green-500");
    }

    function cloudText(cloud){
      if(cloud===null) return {label:"--", chip:"--"};
      if(cloud>=80) return {label:`‚òÅÔ∏è ${cloud}%`, chip:`${cloud}%`};
      if(cloud>=35) return {label:`‚õÖ ${cloud}%`, chip:`${cloud}%`};
      return {label:`üåô ${cloud}%`, chip:`${cloud}%`};
    }

    // Data
    async function fetchSolarWindSummary(){
      const mag = await fetchJson("https://services.swpc.noaa.gov/products/summary/solar-wind-mag-field.json", 8000);
      const spd = await fetchJson("https://services.swpc.noaa.gov/products/summary/solar-wind-speed.json", 8000);
      return { bz: safeNum(mag?.bz), speed: safeNum(spd?.wind_speed), time: mag?.time_tag || spd?.time_tag || null };
    }

    function lastValidRow(table, valueIndex){
      if(!Array.isArray(table) || table.length < 2) return null;
      for(let i = table.length - 1; i >= 1; i--){
        const row = table[i];
        if(!Array.isArray(row) || row.length <= valueIndex) continue;
        const v = safeNum(row[valueIndex]);
        if(v !== null) return row;
      }
      return null;
    }

    async function fetchSolarWindTables(){
      const mag = await fetchJson("https://services.swpc.noaa.gov/products/solar-wind/mag-1-day.json", 12000);
      const plasma = await fetchJson("https://services.swpc.noaa.gov/products/solar-wind/plasma-1-day.json", 12000);
      return { mag, plasma };
    }

    async function fetchKpRobust(){
      const kp = await fetchJson("https://services.swpc.noaa.gov/products/noaa-planetary-k-index-1-day.json", 12000);
      const kpLast = lastValidRow(kp, 1);
      const fallback = (kp.length > 2 && Array.isArray(kp[kp.length-2])) ? safeNum(kp[kp.length-2][1]) : null;
      const kpVal = kpLast ? safeNum(kpLast[1]) : fallback;
      const kpTime = kpLast ? kpLast[0] : (kp.length > 2 ? kp[kp.length-2][0] : null);

      const trend = [];
      for(let i=kp.length-1; i>=1 && trend.length<24; i--){
        const row = kp[i];
        if(!Array.isArray(row) || row.length<2) continue;
        const v = safeNum(row[1]);
        if(v===null) continue;
        trend.push([row[0], v]);
      }
      trend.reverse();
      return { kpVal, kpTime, kpTrend: trend };
    }

    async function fetchCloud(lat, lon){
      try{
        const wx = await fetchJson(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=cloud_cover`, 9000);
        const cloud = wx?.current?.cloud_cover;
        return (typeof cloud==="number" && Number.isFinite(cloud)) ? cloud : null;
      } catch { return null; }
    }

    // Ovation (with fallback)
    function updateOvationPanel(){
      const t = Date.now();
      const img = $("ovationImg");
      $("ovTime").textContent = nowHHMM();

      const primary = `https://services.swpc.noaa.gov/images/animations/ovation-north/latest.jpg?cb=${t}`;
      const fallback = `https://services.swpc.noaa.gov/images/animations/ovation-north/latest.png?cb=${t}`;

      img.onerror = () => { img.onerror = null; img.src = fallback; };
      img.src = primary;
    }

    // Decision
    function computeDecision({bz, speed, kpVal, cloud, moonPenalty}){
      const bzStrong = (bz!==null && bz<=-12);
      const bzOk = (bz!==null && bz<=-5);
      const spdStrong = (speed!==null && speed>=550);
      const spdOk = (speed!==null && speed>=450);
      const kpStrong = (kpVal!==null && kpVal>=7);
      const kpOk = (kpVal!==null && kpVal>=5);
      const cloudBad = (cloud!==null && cloud>=85);

      const moonMsg = moonPenalty==="hell" ? "Mond hell (kontrastarm)" : (moonPenalty==="mittel" ? "Mond mittel" : "Mond dunkel (top)");

      if (bzStrong && spdStrong && (kpOk || kpStrong)){
        return { level:"ALARM", rec: cloudBad ? `Werte brutal gut ‚Äì aber Wolken dick. ${moonMsg}.` : `RAUS! Sehr starke Bedingungen. ${moonMsg}.` };
      }
      if (bzOk && spdOk && kpOk){
        return { level:"CHANCE", rec: cloudBad ? `Aktivit√§t gut, aber wolkig. ${moonMsg}.` : `Gute Chance. ${moonMsg}.` };
      }
      if ((bzOk && spdOk) || (kpStrong && bzOk)){
        return { level:"WATCH", rec: cloudBad ? `Werte interessant, aber Wolken. ${moonMsg}.` : `Watch: m√∂glich, wenn es weiter anzieht. ${moonMsg}.` };
      }
      return { level:"RUHIG", rec: cloudBad ? `Aktuell eher nichts. Wolken sowieso dicht. ${moonMsg}.` : `Aktuell eher nichts. Sp√§ter nochmal laden. ${moonMsg}.` };
    }

    // Map (dark tiles)
    function setupMap(){
      map = L.map("map", { zoomControl:false }).setView([currentLat, currentLon], 9);

      tileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 20
      }).addTo(map);

      marker = L.marker([currentLat, currentLon], { draggable:true }).addTo(map);
      marker.on("dragend", ()=>{
        const p = marker.getLatLng();
        setLocation(p.lat, p.lng, `Manuell: (${p.lat.toFixed(2)}, ${p.lng.toFixed(2)})`);
        updateAll();
      });
    }

    function setLocation(lat, lon, label){
      currentLat = lat; currentLon = lon;
      $("latText").textContent = lat.toFixed(2);
      $("lonText").textContent = lon.toFixed(2);
      $("locationStatus").innerHTML = `Standort: <span class="text-white/80">${label}</span>`;
      if(map && marker){
        marker.setLatLng([lat, lon]);
        map.setView([lat, lon], map.getZoom(), {animate:true});
      }
    }

    async function useGPS(){
      if(!navigator.geolocation){
        $("locationStatus").innerHTML = `Standort: <span class="text-white/80">GPS nicht verf√ºgbar</span>`;
        return;
      }
      $("locationStatus").innerHTML = `Standort: <span class="text-white/80">GPS‚Ä¶ bitte erlauben</span>`;
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          setLocation(lat, lon, `GPS ‚úÖ (${lat.toFixed(2)}, ${lon.toFixed(2)})`);
          updateAll();
        },
        ()=>{ $("locationStatus").innerHTML = `Standort: <span class="text-white/80">GPS abgelehnt</span>`; },
        { enableHighAccuracy:true, timeout:8000, maximumAge:60000 }
      );
    }

    // Autocomplete (Nominatim)
    let suggestTimer = null;

    async function fetchSuggestions(q){
      const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=6&q=${encodeURIComponent(q)}`;
      return await fetchJson(url, 9000);
    }

    function renderSuggestions(items){
      const box = $("suggestions");
      if(!items || items.length===0){
        box.classList.add("hidden");
        box.innerHTML = "";
        return;
      }
      box.classList.remove("hidden");
      box.innerHTML = items.map(it => `
        <button class="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5 transition"
                data-lat="${it.lat}" data-lon="${it.lon}" data-name="${(it.display_name||"").replace(/"/g,"&quot;")}">
          <div class="text-sm text-white/85">${it.display_name}</div>
          <div class="text-[11px] text-white/45 mono">lat ${Number(it.lat).toFixed(3)} ‚Ä¢ lon ${Number(it.lon).toFixed(3)}</div>
        </button>
      `).join("");

      [...box.querySelectorAll("button")].forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const lat = safeNum(btn.dataset.lat);
          const lon = safeNum(btn.dataset.lon);
          const name = btn.dataset.name || "Standort gesetzt";
          if(lat===null || lon===null) return;

          setLocation(lat, lon, name);
          $("placeInput").value = name.split(",").slice(0,2).join(",").trim();
          box.classList.add("hidden");
          box.innerHTML = "";
          updateAll();
        });
      });
    }

    function setupAutocomplete(){
      const input = $("placeInput");
      input.addEventListener("input", ()=>{
        const q = input.value.trim();
        if(suggestTimer) clearTimeout(suggestTimer);
        if(q.length<3){ renderSuggestions([]); return; }
        suggestTimer = setTimeout(async ()=>{
          try{ renderSuggestions(await fetchSuggestions(q)); }
          catch{ renderSuggestions([]); }
        }, 250);
      });

      document.addEventListener("click", (e)=>{
        if(!$("suggestions").contains(e.target) && e.target!==input){
          $("suggestions").classList.add("hidden");
        }
      });
    }

    // Charts
    function buildChartBzSpeed(labels, bzArr, spdArr){
      const ctx = $("chartBzSpeed").getContext("2d");
      if(chartBzSpeed) chartBzSpeed.destroy();

      chartBzSpeed = new Chart(ctx, {
        type:"line",
        data:{
          labels,
          datasets:[
            { label:"Bz (nT)", data:bzArr, tension:.25, pointRadius:0, borderWidth:2, yAxisID:"yBz", spanGaps:false },
            { label:"Speed (km/s)", data:spdArr, tension:.25, pointRadius:0, borderWidth:2, yAxisID:"ySpd", spanGaps:false }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          animation:false,
          plugins:{ legend:{ labels:{ color:"rgba(255,255,255,.7)" } } },
          scales:{
            x:{ ticks:{ color:"rgba(255,255,255,.55)", maxTicksLimit:8 }, grid:{ color:"rgba(255,255,255,.06)" } },
            yBz:{ ticks:{ color:"rgba(255,255,255,.55)" }, grid:{ color:"rgba(255,255,255,.06)" } },
            ySpd:{ position:"right", ticks:{ color:"rgba(255,255,255,.55)" }, grid:{ drawOnChartArea:false } }
          }
        }
      });
    }

    function kpBarColor(v){
      if(v>=7) return "rgba(239, 68, 68, 0.90)";
      if(v>=5) return "rgba(245, 158, 11, 0.90)";
      return "rgba(59, 130, 246, 0.60)";
    }

    function buildChartKp(labels, kpArr){
      const ctx = $("chartKp").getContext("2d");
      if(chartKp) chartKp.destroy();

      chartKp = new Chart(ctx, {
        type:"bar",
        data:{
          labels,
          datasets:[{
            label:"Kp",
            data: kpArr,
            backgroundColor: (ctx)=> kpBarColor(ctx.raw ?? 0),
            borderWidth:0
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          animation:false,
          plugins:{ legend:{ labels:{ color:"rgba(255,255,255,.7)" } } },
          scales:{
            x:{ ticks:{ color:"rgba(255,255,255,.55)", maxTicksLimit:8 }, grid:{ color:"rgba(255,255,255,.06)" } },
            y:{ suggestedMin:0, suggestedMax:9, ticks:{ color:"rgba(255,255,255,.55)" }, grid:{ color:"rgba(255,255,255,.06)" } }
          }
        }
      });
    }

    // ‚úÖ Build a timestamp->speed map (align mag + plasma by time)
    function buildSpeedMap(plasma){
      const map = new Map();
      if(!Array.isArray(plasma)) return map;
      for(let i=1;i<plasma.length;i++){
        const row = plasma[i];
        if(!Array.isArray(row) || row.length < 3) continue;
        const t = row[0];
        const spd = parseFloat(row[2]);
        map.set(t, Number.isFinite(spd) ? spd : null);
      }
      return map;
    }

    // Main update
    async function updateAll(){
      $("updatedAt").textContent = nowHHMM();

      const mi = moonInfo(new Date());
      $("moonVal").textContent = `Mond: ${mi.emoji} ${mi.name} ‚Ä¢ ${mi.illumPct}%`;
      $("moonChip").textContent = `${mi.emoji} ${mi.illumPct}%`;

      updateOvationPanel();

      setDecisionUI("RUHIG", "Lade Daten‚Ä¶");
      $("dataBadge").textContent = "LIVE";

      // Live summary (fast)
      let bz=null, speed=null, feedTime=null;
      try{
        const sw = await fetchSolarWindSummary();
        bz = sw.bz;
        speed = sw.speed;
        feedTime = sw.time || null;
      } catch {}

      // Kp
      let kpVal=null, kpTrend=[];
      try{
        const kp = await fetchKpRobust();
        kpVal = kp.kpVal;
        kpTrend = kp.kpTrend || [];
        feedTime = feedTime || kp.kpTime || null;
      } catch {}

      // Weather
      const cloud = await fetchCloud(currentLat, currentLon);

      // Render values
      $("bzVal").textContent = (bz===null) ? "--" : `${bz.toFixed(1)} nT`;
      $("speedVal").textContent = (speed===null) ? "--" : `${Math.round(speed)}`;
      const ct = cloudText(cloud);
      $("cloudVal").textContent = ct.label;

      $("bzChip").textContent = (bz===null) ? "--" : `${bz.toFixed(1)}nT`;
      $("spdChip").textContent = (speed===null) ? "--" : `${Math.round(speed)}km/s`;
      $("kpChip").textContent = (kpVal===null) ? "--" : kpVal.toFixed(1);
      $("cloudChip").textContent = (cloud===null) ? "--" : `${cloud}%`;

      setBzBar(bz);

      if(bz===null && speed===null && kpVal===null) $("dataBadge").textContent = "OFFLINE";
      else if(bz===null || speed===null) $("dataBadge").textContent = "DEGRADED";
      else $("dataBadge").textContent = feedTime ? ("LIVE ‚Ä¢ "+toHHMMfromISO(feedTime)) : "LIVE";

      const decision = computeDecision({bz, speed, kpVal, cloud, moonPenalty: mi.penalty});
      setDecisionUI(decision.level, decision.rec);

      // ‚úÖ Charts: build with NULLs + HH:MM:SS labels (no duplicates)
      try{
        const { mag, plasma } = await fetchSolarWindTables();
        const speedMap = buildSpeedMap(plasma);

        const magSlice = Array.isArray(mag) ? mag.slice(-60) : []; // little more buffer
        const labels = [], bzArr = [], spdArr = [];

        for(let i=0;i<magSlice.length;i++){
          const row = magSlice[i];
          if(!Array.isArray(row) || row.length < 4) continue;

          const iso = row[0];
          const time = toHHMMSSfromISO(iso); // ‚úÖ seconds
          const bzVal = parseFloat(row[3]);

          // best effort: take plasma speed at same timestamp; else null
          const spdValRaw = speedMap.has(iso) ? speedMap.get(iso) : null;
          const spdVal = (typeof spdValRaw === "number") ? spdValRaw : parseFloat(spdValRaw);

          labels.push(time);
          // ‚úÖ your idea: keep point but set null if invalid
          bzArr.push(Number.isFinite(bzVal) ? bzVal : null);
          spdArr.push(Number.isFinite(spdVal) ? spdVal : null);
        }

        if(labels.length > 10){
          // keep last ~40 points for readability
          const cut = Math.max(0, labels.length - 40);
          buildChartBzSpeed(labels.slice(cut), bzArr.slice(cut), spdArr.slice(cut));
        }
      } catch {}

      // Kp chart
      try{
        if(kpTrend.length > 3){
          const labels = kpTrend.map(r => toHHMMfromISO(r[0]) || "");
          const vals = kpTrend.map(r => r[1]);
          buildChartKp(labels, vals);
        }
      } catch {}
    }

    // Map
    function setupMap(){
      map = L.map("map", { zoomControl:false }).setView([currentLat, currentLon], 9);

      tileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 20
      }).addTo(map);

      marker = L.marker([currentLat, currentLon], { draggable:true }).addTo(map);
      marker.on("dragend", ()=>{
        const p = marker.getLatLng();
        setLocation(p.lat, p.lng, `Manuell: (${p.lat.toFixed(2)}, ${p.lng.toFixed(2)})`);
        updateAll();
      });
    }

    // Init
    function setup(){
      $("btnUpdate").addEventListener("click", ()=>updateAll());
      $("btnGPS").addEventListener("click", ()=>useGPS());

      setupAutocomplete();
      setupMap();
      setLocation(currentLat, currentLon, "Chemnitz");

      updateAll();
      setInterval(updateAll, 60000);
      setInterval(updateOvationPanel, 300000);
    }

    setup();
  </script>
</body>
</html>
