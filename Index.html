<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>AURORA X ‚Äî v6 (Map Top ‚Ä¢ Weather Fix ‚Ä¢ Theme Charts ‚Ä¢ Tips)</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      /* DARK defaults */
      --bg: #070707;
      --fg: #ffffff;

      --card: rgba(255,255,255,.035);
      --border: rgba(255,255,255,.09);
      --muted: rgba(255,255,255,.66);
      --muted2: rgba(255,255,255,.42);

      --glassA: rgba(34,197,94,.14);
      --glassB: rgba(59,130,246,.10);
      --shadow: 0 20px 60px rgba(0,0,0,.55);

      --pill: rgba(0,0,0,.30);
      --pillBorder: rgba(255,255,255,.12);

      --grid: rgba(255,255,255,.10);
      --tick: rgba(255,255,255,.70);

      --statusIdle: rgba(255,255,255,.22);
      --statusText: rgba(255,255,255,.92);

      --btnBg: rgba(255,255,255,.08);
      --btnBorder: rgba(255,255,255,.12);

      --mapModeLabel: "Night Map";
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg: #f6f7f8;
        --fg: #0b0f19;

        --card: rgba(0,0,0,.035);
        --border: rgba(0,0,0,.09);
        --muted: rgba(0,0,0,.66);
        --muted2: rgba(0,0,0,.44);

        --glassA: rgba(34,197,94,.12);
        --glassB: rgba(59,130,246,.08);
        --shadow: 0 22px 60px rgba(0,0,0,.10);

        --pill: rgba(255,255,255,.70);
        --pillBorder: rgba(0,0,0,.10);

        --grid: rgba(0,0,0,.10);
        --tick: rgba(0,0,0,.70);

        --statusIdle: rgba(0,0,0,.18);
        --statusText: rgba(0,0,0,.92);

        --btnBg: rgba(0,0,0,.04);
        --btnBorder: rgba(0,0,0,.10);

        --mapModeLabel: "Day Map";
      }
    }

    html[data-theme="dark"]{
      --bg:#070707; --fg:#fff;
      --card: rgba(255,255,255,.035);
      --border: rgba(255,255,255,.09);
      --muted: rgba(255,255,255,.66);
      --muted2: rgba(255,255,255,.42);
      --glassA: rgba(34,197,94,.14);
      --glassB: rgba(59,130,246,.10);
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --pill: rgba(0,0,0,.30);
      --pillBorder: rgba(255,255,255,.12);
      --grid: rgba(255,255,255,.10);
      --tick: rgba(255,255,255,.70);
      --statusIdle: rgba(255,255,255,.22);
      --statusText: rgba(255,255,255,.92);
      --btnBg: rgba(255,255,255,.08);
      --btnBorder: rgba(255,255,255,.12);
      --mapModeLabel: "Night Map";
    }
    html[data-theme="light"]{
      --bg:#f6f7f8; --fg:#0b0f19;
      --card: rgba(0,0,0,.035);
      --border: rgba(0,0,0,.09);
      --muted: rgba(0,0,0,.66);
      --muted2: rgba(0,0,0,.44);
      --glassA: rgba(34,197,94,.12);
      --glassB: rgba(59,130,246,.08);
      --shadow: 0 22px 60px rgba(0,0,0,.10);
      --pill: rgba(255,255,255,.70);
      --pillBorder: rgba(0,0,0,.10);
      --grid: rgba(0,0,0,.10);
      --tick: rgba(0,0,0,.70);
      --statusIdle: rgba(0,0,0,.18);
      --statusText: rgba(0,0,0,.92);
      --btnBg: rgba(0,0,0,.04);
      --btnBorder: rgba(0,0,0,.10);
      --mapModeLabel: "Day Map";
    }

    html, body{
      background: var(--bg);
      color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      scroll-behavior: smooth;
    }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

    .glass{
      background:
        radial-gradient(900px 400px at 15% -10%, var(--glassA), transparent 60%),
        radial-gradient(800px 380px at 95% 0%, var(--glassB), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02));
      border: 1px solid var(--border);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 16px 50px rgba(0,0,0,.12);
    }

    .badge{
      border: 1px solid var(--pillBorder);
      background: var(--pill);
      border-radius: 999px;
      padding: .25rem .55rem;
      font-size: 10px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      white-space: nowrap;
    }

    .input{
      background: rgba(0,0,0,.08);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      color: var(--fg);
      outline: none;
    }
    html[data-theme="dark"] .input{ background: rgba(0,0,0,.45); }

    .input:focus{
      border-color: rgba(34,197,94,.55);
      box-shadow: 0 0 0 3px rgba(34,197,94,.15);
    }

    .btn{
      border-radius: 14px;
      padding: 10px 14px;
      font-size: 11px;
      font-weight: 800;
      letter-spacing: .12em;
      text-transform: uppercase;
      transition: transform .08s ease, filter .2s ease;
      user-select: none;
      border: 1px solid var(--btnBorder);
      background: var(--btnBg);
      color: var(--fg);
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn-primary{ background: #22c55e; color:#052e16; border-color: rgba(34,197,94,.6); }

    .glow-red{ color:#ef4444; text-shadow: 0 0 24px rgba(239,68,68,.45); }
    .glow-yellow{ color:#f59e0b; text-shadow: 0 0 24px rgba(245,158,11,.35); }
    .glow-green{ color:#22c55e; text-shadow: 0 0 24px rgba(34, 197, 94, .35); }

    #map{
      height: 240px;
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .chart-wrap{ height: 220px; width:100%; position: relative; }
    canvas{ max-width: 100% !important; }

    /* Autocomplete */
    .ac{ position: relative; }
    .ac-list{
      position:absolute;
      top: calc(100% + 8px);
      left:0; right:0;
      z-index: 9999;
      border:1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
      box-shadow: 0 18px 60px rgba(0,0,0,.18);
      background: rgba(255,255,255,.98);
      color: var(--fg);
    }
    html[data-theme="dark"] .ac-list{
      background: rgba(18,18,18,.98);
      box-shadow: 0 18px 60px rgba(0,0,0,.42);
    }
    .ac-item{
      padding: 10px 12px;
      border-top: 1px solid rgba(0,0,0,.06);
      cursor: pointer;
      font-size: 13px;
      color: var(--fg);
    }
    html[data-theme="dark"] .ac-item{ border-top: 1px solid rgba(255,255,255,.06); }
    .ac-item:first-child{ border-top:none; }
    .ac-item:hover{ background: rgba(0,0,0,.06); }
    html[data-theme="dark"] .ac-item:hover{ background: rgba(255,255,255,.08); }

    .img-frame{
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
      background: rgba(0,0,0,.12);
    }
    html[data-theme="dark"] .img-frame{ background: rgba(0,0,0,.35); }
    .img-frame img{ width:100%; height:auto; display:block; }
    .europe-crop{
      width:100%;
      height: 220px;
      object-fit: cover;
      object-position: 65% 60%;
      display:block;
    }
    .gfz img{ filter: brightness(.92) contrast(1.06); }

    /* Bottom Nav */
    .bottom-nav{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      z-index: 9999;
      background: rgba(18,18,18,.72);
      backdrop-filter: blur(14px);
      border-top: 1px solid rgba(255,255,255,.10);
    }
    html[data-theme="light"] .bottom-nav{
      background: rgba(255,255,255,.72);
      border-top: 1px solid rgba(0,0,0,.10);
    }
    .nav-inner{
      max-width: 40rem;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .nav-btn{
      border-radius: 16px;
      padding: 10px 8px;
      text-align: center;
      font-size: 11px;
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--muted);
      border: 1px solid var(--btnBorder);
      background: var(--btnBg);
      user-select: none;
    }
    .nav-btn.active{
      color: var(--fg);
      border-color: rgba(34,197,94,.45);
      box-shadow: 0 0 0 3px rgba(34,197,94,.10);
    }

    /* Floating Tips Button (bottom-left) */
    .fab{
      position: fixed;
      left: 14px;
      bottom: calc(78px + env(safe-area-inset-bottom));
      z-index: 10000;
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: 11px;
      border: 1px solid var(--btnBorder);
      background: var(--btnBg);
      color: var(--fg);
      backdrop-filter: blur(14px);
      box-shadow: 0 18px 60px rgba(0,0,0,.18);
    }

    .sheet{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 10001;
      transform: translateY(110%);
      transition: transform .25s ease;
      padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
    }
    .sheet.open{ transform: translateY(0%); }
    .sheet-inner{
      max-width: 40rem;
      margin: 0 auto;
      border-radius: 22px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.92);
      color: var(--fg);
      backdrop-filter: blur(18px);
      box-shadow: 0 24px 80px rgba(0,0,0,.25);
      overflow: hidden;
    }
    html[data-theme="dark"] .sheet-inner{
      background: rgba(18,18,18,.92);
      box-shadow: 0 24px 80px rgba(0,0,0,.55);
    }
    .sheet-head{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(0,0,0,.08);
    }
    html[data-theme="dark"] .sheet-head{ border-bottom: 1px solid rgba(255,255,255,.08); }
    .sheet-body{
      padding: 14px;
      font-size: 13px;
      color: var(--muted);
    }
    .sheet-body b{ color: var(--fg); }
    .sheet-close{
      border-radius: 999px;
      padding: 8px 10px;
      border: 1px solid var(--btnBorder);
      background: var(--btnBg);
      color: var(--fg);
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: 11px;
    }

    .spacer-bottom{ height: 110px; }
  </style>
</head>

<body class="p-4 md:p-6">
  <div class="max-w-2xl mx-auto">

    <!-- HEADER -->
    <section id="sec-now">
      <div class="glass rounded-2xl p-5 mb-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h1 class="text-xl font-black tracking-tight">AURORA <span class="text-green-400">X</span></h1>
            <div class="flex flex-wrap gap-2 mt-2">
              <span class="badge" id="badgeLive">offline</span>
              <span class="badge">LAT: <span class="mono" id="uiLat">--</span></span>
              <span class="badge">LON: <span class="mono" id="uiLon">--</span></span>
            </div>
          </div>
          <div class="text-right">
            <div class="text-[10px] mono" style="color:var(--muted2)">Letztes Update</div>
            <div class="text-[13px] mono" style="color:var(--muted)" id="uiUpdated">--:--</div>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 gap-3">
          <div class="ac">
            <input id="placeInput" class="input w-full text-sm" placeholder="Ort suchen (z. B. Chemnitz, Leipzig, Berlin) ‚Ä¶" autocomplete="off">
            <div id="acList" class="ac-list hidden"></div>
          </div>

          <div class="flex gap-2">
            <button class="btn btn-primary flex-1" id="btnUpdate">Update</button>
            <button class="btn" id="btnGPS" title="Standort per GPS">üìç</button>
          </div>

          <div class="text-xs" style="color:var(--muted)">
            Tipp: Pin auf einen dunklen Spot ziehen ‚Üí dort Wolken pr√ºfen.
          </div>
        </div>
      </div>

      <!-- ‚úÖ MAP NOW DIRECTLY UNDER HEADER -->
      <section id="sec-map">
        <div class="card p-4 mb-4">
          <div class="flex items-center justify-between mb-3">
            <div class="text-[10px] uppercase font-black tracking-[.25em]" style="color:var(--muted2)">Karte</div>
            <span class="badge" id="mapModeBadge"></span>
          </div>
          <div id="map"></div>

          <!-- ‚úÖ Thresholds made understandable -->
          <div class="mt-4 card p-4">
            <div class="text-[10px] uppercase font-black tracking-[.22em] mb-2" style="color:var(--muted2)">Schwellen (DE-Richtwerte)</div>

            <div class="grid grid-cols-1 gap-2 text-[12px]">
              <div class="badge" style="justify-content:space-between">
                <span>‚úÖ ‚ÄûCHANCE‚Äú</span>
                <span class="mono" style="color:var(--fg)">Nacht + Wolken ‚â§ 60% + (Kp ‚â• 4 ODER Bz ‚â§ -6)</span>
              </div>
              <div class="badge" style="justify-content:space-between; border-color: rgba(245,158,11,.45)">
                <span>üü° ‚ÄûGUT‚Äú</span>
                <span class="mono" style="color:var(--fg)">Kp ‚â• 5 + Bz ‚â§ -8 + Speed ‚â• 500</span>
              </div>
              <div class="badge" style="justify-content:space-between; border-color: rgba(239,68,68,.45)">
                <span>üî¥ ‚ÄûALARM‚Äú</span>
                <span class="mono" style="color:var(--fg)">Kp ‚â• 7 ODER (Bz ‚â§ -12 + Speed ‚â• 600) + klar</span>
              </div>
            </div>

            <div class="text-[11px] mt-3" style="color:var(--muted2)">
              Wichtig: In DE ist <b>Nacht + klare Sicht</b> oft entscheidender als ‚Äûkrasse Werte‚Äú. Immer Testshots.
            </div>
          </div>
        </div>
      </section>

      <!-- DECISION / SCORE -->
      <div class="card p-8 text-center mb-4">
        <div class="badge mx-auto mb-4">Geh ich raus?</div>
        <div id="mainStatus" class="text-6xl font-black tracking-tight" style="color:var(--statusIdle)">ANALYSE</div>
        <div class="mt-2 text-sm italic px-2" id="mainRec" style="color:var(--muted)">Daten werden geladen ‚Ä¶</div>

        <div class="mt-6">
          <div class="flex items-center justify-center gap-2 mb-3">
            <span class="badge">Aurora-Score</span>
            <span class="text-2xl font-black mono" id="uiScore">--</span>
            <span class="text-sm" style="color:var(--muted2)">/ 100</span>
          </div>
          <div class="h-2 w-full rounded-full overflow-hidden" style="background:rgba(255,255,255,.12)">
            <div id="scoreBar" class="h-full" style="width:0%; background:#22c55e"></div>
          </div>
          <div class="mt-3 text-[12px]" id="uiScoreWhy" style="color:var(--muted)">‚Äî</div>

          <div class="flex justify-center gap-2 mt-4">
            <div class="badge">Jetzt <span class="mono" id="fNow">--</span></div>
            <div class="badge">+30m <span class="mono" id="f30">--</span></div>
            <div class="badge">+60m <span class="mono" id="f60">--</span></div>
          </div>
        </div>

        <div class="flex flex-wrap justify-center gap-2 mt-7">
          <span class="badge">Bz <span id="chipBz" class="mono">--</span> nT</span>
          <span class="badge">Speed <span id="chipSpd" class="mono">--</span> km/s</span>
          <span class="badge">Kp <span id="chipKp" class="mono">--</span></span>
          <span class="badge">Wolken <span id="chipCloud" class="mono">--</span></span>
          <span class="badge">Mond <span id="chipMoon" class="mono">--</span></span>
          <span class="badge" id="uiNight">‚Äî</span>
        </div>
      </div>

      <!-- KEY VALUES -->
      <div class="grid grid-cols-2 gap-3 mb-4">
        <div class="card p-4">
          <div class="text-[10px] uppercase font-black tracking-[.22em] mb-1" style="color:var(--muted2)">Sonnenwind Speed</div>
          <div class="text-3xl font-black mono" id="valSpd">--</div>
          <div class="text-[11px]" style="color:var(--muted2)">km/s ‚Ä¢ h√∂her = besser</div>
        </div>
        <div class="card p-4">
          <div class="text-[10px] uppercase font-black tracking-[.22em] mb-1" style="color:var(--muted2)">Magnetfeld Bz</div>
          <div class="text-3xl font-black mono" id="valBz">--</div>
          <div class="text-[11px]" style="color:var(--muted2)">nT ‚Ä¢ je negativer, desto besser</div>
        </div>
      </div>

      <!-- WEATHER -->
      <div class="card p-4 mb-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-[10px] uppercase font-black tracking-[.25em]" style="color:var(--muted2)">Wetter & Nacht</div>
          <span class="badge" id="dayNightBadge">‚Äî</span>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="card p-4">
            <div class="text-[10px] uppercase font-black tracking-[.22em] mb-1" style="color:var(--muted2)">Bew√∂lkung</div>
            <div class="text-3xl font-black mono" id="valCloud">--</div>
            <div class="text-[11px]" style="color:var(--muted2)" id="valCloudTxt">‚Äî</div>
          </div>
          <div class="card p-4">
            <div class="text-[10px] uppercase font-black tracking-[.22em] mb-1" style="color:var(--muted2)">Mond</div>
            <div class="text-3xl font-black mono" id="valMoon">--</div>
            <div class="text-[11px]" style="color:var(--muted2)" id="valMoonTxt">‚Äî</div>
          </div>
        </div>

        <div class="card p-4 mt-3">
          <div class="text-[10px] uppercase font-black tracking-[.22em] mb-2" style="color:var(--muted2)">Sonnenzeiten (heute)</div>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div>
              <div class="text-[11px]" style="color:var(--muted2)">Sonnenuntergang</div>
              <div class="mono font-black" id="sunset">--:--</div>
            </div>
            <div>
              <div class="text-[11px]" style="color:var(--muted2)">Sonnenaufgang</div>
              <div class="mono font-black" id="sunrise">--:--</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- GRAPHS -->
    <section id="sec-graphs">
      <div class="card p-4 mb-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-[10px] uppercase font-black tracking-[.25em]" style="color:var(--muted2)">Bz & Speed (letzte ~2h)</div>
          <span class="badge">filtered</span>
        </div>
        <div class="chart-wrap">
          <canvas id="chartMain"></canvas>
        </div>
      </div>

      <div class="card p-4 mb-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-[10px] uppercase font-black tracking-[.25em]" style="color:var(--muted2)">Kp Index (letzte 24h)</div>
          <span class="badge">gelb ab 5 ‚Ä¢ rot ab 7</span>
        </div>
        <div class="chart-wrap">
          <canvas id="chartKp"></canvas>
        </div>
      </div>

      <div class="card p-4 mb-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-[10px] uppercase font-black tracking-[.25em]" style="color:var(--muted2)">GFZ Potsdam Quicklook</div>
          <span class="badge">Europa oft schneller</span>
        </div>
        <div class="img-frame gfz">
          <img id="gfzImg" alt="GFZ Quicklook" />
        </div>
        <div class="text-[11px] mt-3" style="color:var(--muted2)">
          Wenn leer ‚Üí GFZ kurz down. Sp√§ter Refresh.
        </div>
      </div>

      <div class="card p-4 mb-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-[10px] uppercase font-black tracking-[.25em]" style="color:var(--muted2)">OVATION Oval (NOAA)</div>
          <button class="btn" id="btnOvaRefresh">Refresh</button>
        </div>

        <div class="grid grid-cols-1 gap-3">
          <div class="img-frame">
            <img id="ovationGlobal" alt="NOAA Ovation Global" />
          </div>
          <div class="img-frame">
            <img id="ovationEurope" class="europe-crop" alt="NOAA Ovation Europa-Zoom" />
          </div>
        </div>

        <div class="flex items-center justify-between mt-3">
          <div class="text-[11px]" style="color:var(--muted2)">
            Praxis: Bz + Speed + Wolken + dunkler Spot.
          </div>
          <span class="badge">refresh: <span id="ovaTime" class="mono">--:--</span></span>
        </div>

        <div id="ovationFallback" class="hidden mt-3 text-sm" style="color:var(--muted)">
          OVATION nicht erreichbar. Sp√§ter refreshen.
        </div>
      </div>
    </section>

    <!-- MORE -->
    <section id="sec-more">
      <div class="card p-4 mb-8">
        <div class="flex items-center justify-between mb-3">
          <div class="text-[10px] uppercase font-black tracking-[.25em]" style="color:var(--muted2)">Mehr</div>
          <span class="badge">v6</span>
        </div>

        <div class="grid grid-cols-1 gap-2 text-sm">
          <button class="btn text-left" id="btnTheme">Theme: System</button>
          <button class="btn text-left" id="btnHardRefresh">Hard Refresh (Cache-bust)</button>
          <a class="btn text-left" target="_blank" rel="noreferrer" href="https://www.lightpollutionmap.info/">Light Pollution Map</a>
          <a class="btn text-left" target="_blank" rel="noreferrer" href="https://www.swpc.noaa.gov/">NOAA SWPC</a>
          <a class="btn text-left" target="_blank" rel="noreferrer" href="https://kp.gfz-potsdam.de/">GFZ Potsdam</a>
          <a class="btn text-left" target="_blank" rel="noreferrer" href="https://www.windy.com/">Windy</a>
        </div>
      </div>
    </section>

    <div class="spacer-bottom"></div>
  </div>

  <!-- Tips FAB -->
  <button class="fab" id="btnTips">Tipps</button>

  <!-- Tips Sheet -->
  <div class="sheet" id="tipsSheet">
    <div class="sheet-inner">
      <div class="sheet-head">
        <div class="badge">Schnellhilfe</div>
        <button class="sheet-close" id="btnTipsClose">Schlie√üen</button>
      </div>
      <div class="sheet-body">
        <div class="grid gap-3">
          <div>
            <b>Wenn alles leer ist:</b><br>
            1) <b>Hard Refresh</b> (Mehr) ‚Ä¢ 2) kurz warten ‚Ä¢ 3) nochmal Update.
          </div>
          <div>
            <b>Wenn ‚ÄûCHANCE‚Äú:</b><br>
            Norden, dunkler Spot, 5‚Äì10 Testshots.
          </div>
          <div>
            <b>Kamera Quick-Setup (Start):</b><br>
            24‚Äì35mm ‚Ä¢ f/1.8‚Äì2.8 ‚Ä¢ ISO 1600‚Äì6400 ‚Ä¢ 2‚Äì8s ‚Ä¢ Fokus manuell ‚àû
          </div>
          <div>
            <b>DE-Faustregel:</b><br>
            Nacht + klar &gt; perfekte Werte. Wolken killen alles.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <div class="bottom-nav">
    <div class="nav-inner">
      <div class="nav-btn active" data-target="sec-now">Jetzt</div>
      <div class="nav-btn" data-target="sec-map">Karte</div>
      <div class="nav-btn" data-target="sec-graphs">Grafiken</div>
      <div class="nav-btn" data-target="sec-more">Mehr</div>
    </div>
  </div>

<script>
/***********************
 * CONFIG
 ***********************/
const NOAA = {
  magSummary: "https://services.swpc.noaa.gov/products/summary/solar-wind-mag-field.json",
  spdSummary: "https://services.swpc.noaa.gov/products/summary/solar-wind-speed.json",
  mag1d: "https://services.swpc.noaa.gov/products/solar-wind/mag-1-day.json",
  plasma1d: "https://services.swpc.noaa.gov/products/solar-wind/plasma-1-day.json",
  kp1d: "https://services.swpc.noaa.gov/products/noaa-planetary-k-index-1-day.json",
  ovationNH: "https://services.swpc.noaa.gov/images/aurora-forecast-northern-hemisphere.jpg"
};

const GEO = {
  search: (q) =>
    `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=6&language=de&format=json`
};

const OPEN_METEO = {
  url: (lat, lon) =>
    `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&current=cloud_cover,is_day&daily=sunrise,sunset,moon_illumination&timezone=auto`
};

function gfzQuicklookUrlYYYYMMDD(yyyy_mm_dd){
  return `https://kp.gfz-potsdam.de/fileadmin/kp-archiv/png/${yyyy_mm_dd}.png`;
}

/***********************
 * STATE
 ***********************/
let currentLat = 50.83, currentLon = 12.92;
let chartMain = null, chartKp = null;
let map, marker, tileLayer = null;
let acTimer = null;

let lastGood = {
  bz:null, spd:null, kp:null,
  cloud:null, moon:null,
  sunrise:null, sunset:null,
  isNight:null
};

let lastTrend = { labels:[], bzArr:[], spdArr:[] };

const $ = (id) => document.getElementById(id);

/***********************
 * THEME
 ***********************/
const THEME_KEY = "auroraX_theme";

function getStoredTheme(){
  return localStorage.getItem(THEME_KEY) || "system";
}
function applyTheme(mode){
  localStorage.setItem(THEME_KEY, mode);
  if(mode === "system") document.documentElement.removeAttribute("data-theme");
  else document.documentElement.setAttribute("data-theme", mode);

  updateThemeButton();
  updateMapTiles();
  rerenderCharts(); // important for light theme
}
function updateThemeButton(){
  const mode = getStoredTheme();
  const label = mode === "system" ? "System" : (mode === "light" ? "Hell" : "Dunkel");
  $("btnTheme").textContent = `Theme: ${label}`;
}
function cycleTheme(){
  const mode = getStoredTheme();
  const next = mode === "system" ? "dark" : mode === "dark" ? "light" : "system";
  applyTheme(next);
}

/***********************
 * HELPERS
 ***********************/
function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
function safeNum(x){
  const n = Number.parseFloat(x);
  return Number.isFinite(n) ? n : null;
}
function hhmmFromISO(s){
  if(!s) return null;
  const parts = String(s).split(" ");
  if(parts.length < 2) return String(s).slice(11,16);
  return parts[1].slice(0,5);
}
function fmtTimeLocal(date = new Date()){
  return date.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
}
function cssVar(name){
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}

async function fetchJson(url, timeoutMs=9000){
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), timeoutMs);
  try{
    const res = await fetch(url, { cache:"no-store", signal: ctrl.signal });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  }catch(e){
    return null;
  }finally{
    clearTimeout(t);
  }
}

function lastValidRow(table, idx){
  if(!Array.isArray(table) || table.length < 2) return null;
  for(let i = table.length - 1; i >= 1; i--){
    const row = table[i];
    const v = safeNum(row?.[idx]);
    if(v !== null) return row;
  }
  return null;
}

/***********************
 * AUTOCOMPLETE
 ***********************/
function hideAc(){
  $("acList").classList.add("hidden");
  $("acList").innerHTML = "";
}
function showAc(items){
  const box = $("acList");
  box.innerHTML = "";
  if(!items || !items.length){ hideAc(); return; }

  items.forEach(it => {
    const div = document.createElement("div");
    div.className = "ac-item";
    div.textContent = it.label;
    div.onclick = () => {
      currentLat = it.lat;
      currentLon = it.lon;
      $("placeInput").value = it.short || it.label;
      hideAc();
      moveMap(currentLat, currentLon, true);
      updateAll();
    };
    box.appendChild(div);
  });
  box.classList.remove("hidden");
}
async function acSearch(q){
  const data = await fetchJson(GEO.search(q), 8000);
  const res = data?.results;
  if(!Array.isArray(res)) return [];
  return res.map(r => ({
    lat: r.latitude,
    lon: r.longitude,
    short: r.name,
    label: [r.name, r.admin1, r.country].filter(Boolean).join(", ")
  }));
}

/***********************
 * MAP
 ***********************/
function moveMap(lat, lon, animate=false){
  $("uiLat").textContent = Number(lat).toFixed(2);
  $("uiLon").textContent = Number(lon).toFixed(2);
  if(map && marker){
    marker.setLatLng([lat, lon]);
    map.setView([lat, lon], map.getZoom(), { animate });
  }
}

function isDarkNow(){
  const htmlTheme = document.documentElement.getAttribute("data-theme");
  if(htmlTheme) return htmlTheme === "dark";
  return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
}

function getTileUrl(){
  return isDarkNow()
    ? "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png"
    : "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png";
}

function updateMapTiles(){
  if(!map || !tileLayer) return;
  tileLayer.setUrl(getTileUrl());
  $("mapModeBadge").textContent = isDarkNow() ? "Night Map" : "Day Map";
}

function setupMap(){
  map = L.map("map", { zoomControl: true }).setView([currentLat, currentLon], 9);

  tileLayer = L.tileLayer(getTileUrl(), {
    attribution: '&copy; OpenStreetMap &copy; CARTO',
    subdomains: "abcd",
    maxZoom: 20
  }).addTo(map);

  updateMapTiles();

  marker = L.marker([currentLat, currentLon], { draggable: true }).addTo(map);
  marker.on("dragend", () => {
    const p = marker.getLatLng();
    currentLat = p.lat;
    currentLon = p.lng;
    moveMap(currentLat, currentLon);
    updateAll();
  });
}

/***********************
 * SCORE + DECISION
 ***********************/
function computeAuroraScore({ bz, spd, kp, cloud, moonIllum, isNight }){
  let score = 0;

  if(kp !== null) score += clamp((kp/9)*70, 0, 70);
  if(bz !== null){
    score += clamp(((-bz)/20)*20, 0, 20);
    if(bz <= -10) score += 6;
  }
  if(spd !== null){
    score += clamp(((spd-300)/500)*18, 0, 18);
    if(spd >= 600) score += 4;
  }

  if(isNight === false) score *= 0.22;

  if(cloud !== null){
    const clearFactor = clamp((100-cloud)/100, 0, 1);
    score *= clearFactor;
  }
  if(moonIllum !== null){
    score -= clamp((moonIllum/100)*18, 0, 18);
  }

  score = Math.round(clamp(score, 0, 100));

  const why = [];
  why.push(isNight === false ? "Tag" : "Nacht");
  if(cloud !== null) why.push(cloud <= 30 ? "klar" : cloud <= 60 ? "teils" : "bew√∂lkt");
  if(kp !== null) why.push(kp >= 7 ? "Kp rot" : kp >= 5 ? "Kp gelb" : kp >= 4 ? "Kp ok" : "Kp niedrig");
  if(bz !== null) why.push(bz <= -10 ? "Bz gut" : bz <= -4 ? "Bz ok" : "Bz schwach");
  if(spd !== null) why.push(spd >= 650 ? "Speed top" : spd >= 500 ? "Speed gut" : "Speed niedrig");
  if(moonIllum !== null) why.push(moonIllum <= 20 ? "Mond dunkel" : moonIllum <= 60 ? "Mond mittel" : "Mond hell");

  return { score, why: why.join(" ‚Ä¢ ") };
}

function decideStatus({ score, bz, spd, cloud, isNight }){
  const statusEl = $("mainStatus");
  statusEl.className = "text-6xl font-black tracking-tight";
  statusEl.style.color = cssVar("--statusText");

  const strong = (bz !== null && spd !== null && bz <= -10 && spd >= 520);
  const veryClear = (cloud !== null && cloud <= 30);
  const okNight = (isNight !== false);

  if(okNight && (score >= 70 || (strong && veryClear))){
    statusEl.textContent = "ALARM";
    statusEl.classList.add("glow-red");
    $("mainRec").textContent = `RAUS! Norden + Langzeitbelichtung. ${cloud !== null ? (cloud <= 30 ? "Wolken gut." : "Wolken checken!") : ""}`;
    return;
  }
  if(okNight && score >= 40){
    statusEl.textContent = "CHANCE";
    statusEl.classList.add("glow-yellow");
    $("mainRec").textContent = "Beobachten! Testshots (Norden) & dunklen Spot w√§hlen.";
    return;
  }

  statusEl.textContent = "RUHIG";
  statusEl.style.color = cssVar("--statusIdle");
  $("mainRec").textContent = okNight ? "Aktuell eher nichts. Sp√§ter nochmal checken." : "Der Himmel ist noch zu hell. Sp√§ter nochmal checken.";
}

function updateScoreUI(score, why){
  $("uiScore").textContent = score;
  $("uiScoreWhy").textContent = why || "‚Äî";
  $("scoreBar").style.width = `${score}%`;

  if(score >= 70) $("scoreBar").style.background = "#ef4444";
  else if(score >= 40) $("scoreBar").style.background = "#f59e0b";
  else $("scoreBar").style.background = "#22c55e";
}

/***********************
 * CHARTS
 ***********************/
function buildChartBzSpeed(labels, bzArr, spdArr){
  const ctx = $("chartMain").getContext("2d");
  if(chartMain) chartMain.destroy();

  chartMain = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        { label:"Bz (nT)", data:bzArr, borderColor:"#3b82f6", borderWidth:2, pointRadius:0, tension:.35, yAxisID:"y" },
        { label:"Speed (km/s)", data:spdArr, borderColor:"#ef4444", borderWidth:2, pointRadius:0, tension:.35, yAxisID:"y1" }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: {
        legend: { display:true, labels:{ color: cssVar("--tick"), boxWidth: 18 } }
      },
      scales: {
        x: { grid:{ color: cssVar("--grid") }, ticks:{ color: cssVar("--tick"), maxTicksLimit: 8 } },
        y: { position:"left", grid:{ color: cssVar("--grid") }, ticks:{ color: cssVar("--tick") } },
        y1:{ position:"right", grid:{ display:false }, ticks:{ color: cssVar("--tick") } }
      }
    }
  });
}

function kpColor(v){
  if(v === null) return "rgba(180,180,180,.20)";
  if(v >= 7) return "rgba(239,68,68,.85)";
  if(v >= 5) return "rgba(245,158,11,.85)";
  return "rgba(34,197,94,.65)";
}

function buildChartKp(labels, values){
  const ctx = $("chartKp").getContext("2d");
  if(chartKp) chartKp.destroy();

  chartKp = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: values.map(kpColor),
        borderWidth: 0,
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: { legend: { display:false } },
      scales: {
        x: { grid:{ color: cssVar("--grid") }, ticks:{ color: cssVar("--tick"), maxTicksLimit: 10 } },
        y: { suggestedMin:0, suggestedMax:9, grid:{ color: cssVar("--grid") }, ticks:{ color: cssVar("--tick") } }
      }
    }
  });
}

function rerenderCharts(){
  if(lastTrend.labels.length){
    buildChartBzSpeed(lastTrend.labels, lastTrend.bzArr, lastTrend.spdArr);
  }
  if(window.__lastKp && window.__lastKp.labels?.length){
    buildChartKp(window.__lastKp.labels, window.__lastKp.values);
  }
}

/***********************
 * OVATION + GFZ
 ***********************/
function refreshOvation(){
  $("ovationFallback").classList.add("hidden");
  const ts = Date.now();
  const src = `${NOAA.ovationNH}?ts=${ts}`;

  const g = $("ovationGlobal");
  const e = $("ovationEurope");
  const onerr = () => $("ovationFallback").classList.remove("hidden");
  g.onerror = onerr; e.onerror = onerr;

  g.src = src;
  e.src = src;

  $("ovaTime").textContent = fmtTimeLocal();
}

function refreshGFZ(){
  const d = new Date();
  const yyyy_mm_dd = d.toISOString().slice(0,10);
  const url = gfzQuicklookUrlYYYYMMDD(yyyy_mm_dd) + `?ts=${Date.now()}`;
  const img = $("gfzImg");
  img.onerror = () => {
    img.removeAttribute("src");
    img.alt = "GFZ Quicklook aktuell nicht erreichbar.";
  };
  img.src = url;
}

/***********************
 * FORECAST FROM TREND
 ***********************/
function computeForecastFromTrend(){
  const bzA = lastTrend.bzArr.filter(v => Number.isFinite(v));
  const spA = lastTrend.spdArr.filter(v => Number.isFinite(v));
  if(bzA.length < 10 || spA.length < 10) return { now:null, m30:null, m60:null };

  const avg = (arr) => arr.reduce((a,b)=>a+b,0)/arr.length;

  const nowBz = avg(bzA.slice(-10));
  const nowSp = avg(spA.slice(-10));
  const m30Bz = avg(bzA.slice(-30, -15));
  const m30Sp = avg(spA.slice(-30, -15));
  const m60Bz = avg(bzA.slice(-60, -45));
  const m60Sp = avg(spA.slice(-60, -45));

  const scoreLite = (bz, spd) => {
    let s = 0;
    if(bz !== null){ s += clamp(((-bz)/20)*45, 0, 45); if(bz <= -10) s += 10; }
    if(spd !== null){ s += clamp(((spd-300)/500)*35, 0, 35); if(spd >= 600) s += 8; }
    return Math.round(clamp(s, 0, 100));
  };

  return { now: scoreLite(nowBz, nowSp), m30: scoreLite(m30Bz, m30Sp), m60: scoreLite(m60Bz, m60Sp) };
}

/***********************
 * UPDATE
 ***********************/
async function updateAll(){
  $("badgeLive").textContent = "lade‚Ä¶";
  $("badgeLive").className = "badge";

  moveMap(currentLat, currentLon);

  const [magSum, spdSum] = await Promise.all([
    fetchJson(NOAA.magSummary, 9000),
    fetchJson(NOAA.spdSummary, 9000)
  ]);

  let bz = null, spd = null;
  if(magSum && typeof magSum === "object") bz = safeNum(magSum.bz ?? magSum.Bz ?? magSum.bz_gsm);
  if(spdSum && typeof spdSum === "object") spd = safeNum(spdSum.wind_speed ?? spdSum.speed ?? spdSum.WindSpeed);

  const [mag1d, plasma1d, kp1d] = await Promise.all([
    fetchJson(NOAA.mag1d, 14000),
    fetchJson(NOAA.plasma1d, 14000),
    fetchJson(NOAA.kp1d, 14000)
  ]);

  let kp = null;
  if(Array.isArray(kp1d)){
    const last = lastValidRow(kp1d, 1);
    kp = last ? safeNum(last[1]) : null;
    if(kp === null && kp1d.length > 2) kp = safeNum(kp1d[kp1d.length-2]?.[1]);
  }

  if(bz === null && Array.isArray(mag1d)){
    const last = lastValidRow(mag1d, 3);
    bz = last ? safeNum(last[3]) : null;
  }
  if(spd === null && Array.isArray(plasma1d)){
    const last = lastValidRow(plasma1d, 2);
    spd = last ? safeNum(last[2]) : null;
  }

  if(bz !== null) lastGood.bz = bz;
  if(spd !== null) lastGood.spd = spd;
  if(kp !== null) lastGood.kp = kp;

  const wx = await fetchJson(OPEN_METEO.url(currentLat, currentLon), 12000);
  const cloud = safeNum(wx?.current?.cloud_cover);
  const isDayVal = wx?.current?.is_day;
  const isNight = (isDayVal === 0);

  const sunriseIso = wx?.daily?.sunrise?.[0] ?? null;
  const sunsetIso  = wx?.daily?.sunset?.[0]  ?? null;
  const sunrise = sunriseIso ? String(sunriseIso).slice(11,16) : null;
  const sunset  = sunsetIso  ? String(sunsetIso).slice(11,16)  : null;

  let moonIllum = null;
  if(Array.isArray(wx?.daily?.moon_illumination)) moonIllum = safeNum(wx.daily.moon_illumination[0]);

  if(cloud !== null) lastGood.cloud = cloud;
  if(moonIllum !== null) lastGood.moon = moonIllum;
  if(sunrise) lastGood.sunrise = sunrise;
  if(sunset) lastGood.sunset = sunset;
  if(isDayVal === 0 || isDayVal === 1) lastGood.isNight = isNight;

  // UI set (with lastGood fallback if null)
  const uiBz = (bz !== null) ? bz : lastGood.bz;
  const uiSp = (spd !== null) ? spd : lastGood.spd;
  const uiKp = (kp !== null) ? kp : lastGood.kp;
  const uiCloud = (cloud !== null) ? cloud : lastGood.cloud;
  const uiMoon = (moonIllum !== null) ? moonIllum : lastGood.moon;
  const uiSunrise = sunrise || lastGood.sunrise;
  const uiSunset  = sunset  || lastGood.sunset;
  const uiNight = (isDayVal === 0 || isDayVal === 1) ? isNight : lastGood.isNight;

  $("valBz").textContent = (uiBz !== null) ? uiBz.toFixed(1) : "--";
  $("valSpd").textContent = (uiSp !== null) ? Math.round(uiSp) : "--";

  $("chipBz").textContent = (uiBz !== null) ? uiBz.toFixed(1) : "--";
  $("chipSpd").textContent = (uiSp !== null) ? Math.round(uiSp) : "--";
  $("chipKp").textContent = (uiKp !== null) ? uiKp.toFixed(1) : "--";
  $("chipCloud").textContent = (uiCloud !== null) ? `${Math.round(uiCloud)}%` : "--";
  $("chipMoon").textContent = (uiMoon !== null) ? `${Math.round(uiMoon)}%` : "--";

  $("valCloud").textContent = (uiCloud !== null) ? `${Math.round(uiCloud)}%` : "--";
  $("valCloudTxt").textContent = (uiCloud === null) ? "‚Äî" : (uiCloud > 80 ? "Bew√∂lkt ‚òÅÔ∏è" : uiCloud > 35 ? "Teils klar ‚õÖ" : "Klar ‚ú®");

  $("valMoon").textContent = (uiMoon !== null) ? `${Math.round(uiMoon)}%` : "--";
  $("valMoonTxt").textContent = (uiMoon === null) ? "‚Äî" : (uiMoon > 70 ? "hell" : uiMoon > 30 ? "mittel" : "dunkel (top)");

  $("sunrise").textContent = uiSunrise || "--:--";
  $("sunset").textContent = uiSunset || "--:--";

  $("uiNight").textContent = (uiNight === null) ? "‚Äî" : (uiNight ? "Nacht" : "Tag");
  $("dayNightBadge").textContent = $("uiNight").textContent;

  $("uiUpdated").textContent = fmtTimeLocal();

  const liveOk = (uiBz !== null || uiSp !== null || uiKp !== null);
  $("badgeLive").textContent = liveOk ? "live" : "offline";
  if(liveOk) $("badgeLive").classList.add("glow-green");

  const scorePack = computeAuroraScore({ bz:uiBz, spd:uiSp, kp:uiKp, cloud:uiCloud, moonIllum:uiMoon, isNight:uiNight });
  updateScoreUI(scorePack.score, scorePack.why);
  decideStatus({ score: scorePack.score, bz:uiBz, spd:uiSp, cloud:uiCloud, isNight:uiNight });

  renderTrendChart(mag1d, plasma1d);
  renderKpChart(kp1d);

  const fc = computeForecastFromTrend();
  $("fNow").textContent = (fc.now === null) ? "--" : fc.now;
  $("f30").textContent = (fc.m30 === null) ? "--" : fc.m30;
  $("f60").textContent = (fc.m60 === null) ? "--" : fc.m60;

  refreshGFZ();
  refreshOvation();
}

function renderTrendChart(mag, plasma){
  if(!Array.isArray(mag) || !Array.isArray(plasma)) return;

  const magSlice = mag.slice(-140);
  const plSlice  = plasma.slice(-140);
  const len = Math.min(magSlice.length, plSlice.length);

  const labels = [], bzArr = [], spdArr = [];
  for(let i=0; i<len; i++){
    const m = magSlice[i];
    const p = plSlice[i];
    const t = hhmmFromISO(m?.[0]) || hhmmFromISO(p?.[0]) || null;
    if(!t) continue;

    const bzVal = safeNum(m?.[3]);
    const spVal = safeNum(p?.[2]);

    labels.push(t);
    bzArr.push(Number.isFinite(bzVal) ? bzVal : null);
    spdArr.push(Number.isFinite(spVal) ? spVal : null);
  }

  const maxPoints = 80;
  const cut = labels.length > maxPoints ? labels.length - maxPoints : 0;

  lastTrend = { labels: labels.slice(cut), bzArr: bzArr.slice(cut), spdArr: spdArr.slice(cut) };
  buildChartBzSpeed(lastTrend.labels, lastTrend.bzArr, lastTrend.spdArr);
}

function renderKpChart(kpTable){
  if(!Array.isArray(kpTable) || kpTable.length < 3) return;

  const rows = kpTable.slice(1).slice(-16);
  const labels = [], values = [];

  rows.forEach(r => {
    const t = hhmmFromISO(r?.[0]) || String(r?.[0]||"").slice(11,16);
    const v = safeNum(r?.[1]);
    if(!t) return;
    labels.push(t);
    values.push(Number.isFinite(v) ? v : null);
  });

  const maxBars = 12;
  const cut = labels.length > maxBars ? labels.length - maxBars : 0;

  window.__lastKp = { labels: labels.slice(cut), values: values.slice(cut) };
  buildChartKp(window.__lastKp.labels, window.__lastKp.values);
}

/***********************
 * EVENTS
 ***********************/
$("btnUpdate").addEventListener("click", () => updateAll());

$("btnGPS").addEventListener("click", () => {
  if(!navigator.geolocation){
    alert("GPS nicht verf√ºgbar.");
    return;
  }
  $("badgeLive").textContent = "gps‚Ä¶";
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      currentLat = pos.coords.latitude;
      currentLon = pos.coords.longitude;
      $("placeInput").value = "";
      hideAc();
      moveMap(currentLat, currentLon, true);
      updateAll();
    },
    () => {
      alert("Ortung abgelehnt oder fehlgeschlagen.");
      $("badgeLive").textContent = "offline";
    },
    { enableHighAccuracy: true, timeout: 10000 }
  );
});

$("btnOvaRefresh").addEventListener("click", () => refreshOvation());

$("placeInput").addEventListener("input", (e) => {
  const q = e.target.value.trim();
  clearTimeout(acTimer);

  if(q.length < 2){
    hideAc();
    return;
  }
  acTimer = setTimeout(async () => {
    const items = await acSearch(q);
    showAc(items);
  }, 220);
});

document.addEventListener("click", (e) => {
  const ac = $("placeInput");
  const list = $("acList");
  if(e.target !== ac && !list.contains(e.target)) hideAc();
});

$("btnTheme").addEventListener("click", () => cycleTheme());

$("btnHardRefresh").addEventListener("click", () => {
  const url = new URL(location.href);
  url.searchParams.set("ts", Date.now());
  location.href = url.toString();
});

// Bottom nav
document.querySelectorAll(".nav-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const target = btn.getAttribute("data-target");
    document.getElementById(target)?.scrollIntoView({ behavior:"smooth", block:"start" });
    document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  });
});

// Tips sheet
$("btnTips").addEventListener("click", () => $("tipsSheet").classList.add("open"));
$("btnTipsClose").addEventListener("click", () => $("tipsSheet").classList.remove("open"));
$("tipsSheet").addEventListener("click", (e) => {
  if(e.target.id === "tipsSheet") $("tipsSheet").classList.remove("open");
});

/***********************
 * INIT
 ***********************/
function init(){
  applyTheme(getStoredTheme());
  updateThemeButton();

  moveMap(currentLat, currentLon);
  setupMap();

  if(window.matchMedia){
    window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
      if(getStoredTheme() === "system"){
        updateMapTiles();
        rerenderCharts();
      }
    });
  }

  refreshOvation();
  refreshGFZ();
  updateAll();
  setInterval(updateAll, 60000);
}
init();
</script>
</body>
</html>
