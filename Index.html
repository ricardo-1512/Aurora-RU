<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aurora X ‚Äì Standort-Update</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0f1115; --panel:#171a21; --panel2:#1e2330; --text:#e9eef7; --muted:#a8b3c7;
      --ok:#40c057; --warn:#ffd43b; --bad:#ff4d4f; --info:#4dabf7; --line:#2a3142;
      --chip:#22283a; --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:radial-gradient(1200px 700px at 15% -10%, #1b2a4a 0%, rgba(27,42,74,0) 60%),
                    radial-gradient(1200px 700px at 85% 0%, #2a1b4a 0%, rgba(42,27,74,0) 55%),
                    var(--bg);
      color:var(--text); font: 15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      padding:18px;
    }
    a{color:#8fd3ff; text-decoration:none}
    a:hover{ text-decoration:underline }

    .container{ max-width:1100px; margin:0 auto; display:flex; flex-direction:column; gap:14px; }
    .topbar{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;
      padding:14px 16px; border:1px solid var(--line); background:rgba(23,26,33,.7); border-radius:var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }
    .brand{
      display:flex; flex-direction:column; gap:4px;
    }
    .brand h1{
      margin:0; font-size:18px; letter-spacing:.2px;
    }
    .brand .sub{
      color:var(--muted); font-size:13px;
    }

    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;
    }
    label{ font-size:12px; color:var(--muted); display:block; margin:0 0 6px 2px;}
    .field{ display:flex; flex-direction:column; }
    input, button{
      border-radius:12px; border:1px solid var(--line);
      background:rgba(30,35,48,.65); color:var(--text);
      padding:10px 12px; outline:none;
    }
    input{ width:170px; }
    input.small{ width:120px; }
    button{
      cursor:pointer; background:linear-gradient(180deg, rgba(77,171,247,.25), rgba(77,171,247,.08));
      border-color:rgba(77,171,247,.35);
      font-weight:600;
    }
    button:hover{ filter:brightness(1.1) }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px; background:rgba(34,40,58,.75); border:1px solid var(--line);
      color:var(--muted); font-size:12px;
    }
    .dot{ width:10px; height:10px; border-radius:50%; background:#666; display:inline-block }
    .dot.ok{ background:var(--ok) } .dot.warn{ background:var(--warn) } .dot.bad{ background:var(--bad) } .dot.info{ background:var(--info) }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      input{ width:160px; }
    }

    .card{
      border:1px solid var(--line); background:rgba(23,26,33,.72);
      border-radius:var(--radius); box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card header{
      padding:14px 16px; border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      background:rgba(30,35,48,.45);
    }
    .card header h2{
      margin:0; font-size:14px; letter-spacing:.2px;
    }
    .card .body{ padding:14px 16px; }

    .hero{
      display:flex; flex-direction:column; gap:12px;
    }
    .decision{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      padding:14px; border-radius:16px; border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    }
    .decision .left{ display:flex; flex-direction:column; gap:6px; }
    .decision .title{ font-size:12px; color:var(--muted); }
    .decision .big{
      font-size:28px; font-weight:850; letter-spacing:.4px;
    }
    .decision .right{
      display:flex; flex-direction:column; align-items:flex-end; gap:6px;
      min-width:220px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:999px; font-weight:800; letter-spacing:.25px;
      border:1px solid var(--line);
    }
    .pill.ok{ background: rgba(64,192,87,.18); border-color: rgba(64,192,87,.35); color:#c9f7d1;}
    .pill.warn{ background: rgba(255,212,59,.14); border-color: rgba(255,212,59,.30); color:#fff4c2;}
    .pill.bad{ background: rgba(255,77,79,.12); border-color: rgba(255,77,79,.30); color:#ffd2d3;}
    .pill.info{ background: rgba(77,171,247,.14); border-color: rgba(77,171,247,.30); color:#d6ecff;}

    .kpis{
      display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;
    }
    @media (max-width: 760px){ .kpis{ grid-template-columns: repeat(2, 1fr); } }
    .kpi{
      padding:12px; border-radius:14px; border:1px solid var(--line);
      background: rgba(30,35,48,.35);
      display:flex; flex-direction:column; gap:4px;
      min-height:78px;
    }
    .kpi .label{ font-size:12px; color:var(--muted) }
    .kpi .value{ font-size:18px; font-weight:800 }
    .kpi .hint{ font-size:12px; color:var(--muted) }

    .explain{
      color:var(--muted); font-size:13px; margin-top:4px;
    }
    .mini{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;
    }
    .mini .chip strong{ color:var(--text); font-weight:700 }

    .maps{
      display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;
    }
    @media (max-width: 980px){ .maps{ grid-template-columns: 1fr; } }
    figure{ margin:0; border:1px solid var(--line); border-radius:14px; overflow:hidden; background:rgba(15,17,21,.55); }
    figcaption{ padding:10px 12px; font-size:12px; color:var(--muted); border-bottom:1px solid var(--line); background:rgba(30,35,48,.35);}
    img{ width:100%; display:block; }

    .sources{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px; }
    .sources li{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius:14px; border:1px solid var(--line);
      background: rgba(30,35,48,.28);
    }
    .sources .left{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      min-width: 0;
    }
    .sources .left a{ font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:420px; }
    .tag{ font-size:12px; color:var(--muted); background:rgba(34,40,58,.8); border:1px solid var(--line); padding:3px 8px; border-radius:999px; }
    .rightnote{ color:var(--muted); font-size:12px; white-space:nowrap; }

    .footer{
      color:var(--muted); font-size:12px; text-align:center; padding:10px 0;
    }
    .muted{ color:var(--muted) }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .sep{ height:1px; background:var(--line); margin:12px 0; }

    /* Wetter widgets */
    .iframeWrap{
      border:1px solid var(--line); border-radius:14px; overflow:hidden; background:rgba(15,17,21,.4);
    }
    iframe{ width:100%; border:0; display:block; }
  </style>
</head>

<body>
<div class="container">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="brand">
      <h1>üåå Aurora X ‚Äì Standort-Update</h1>
      <div class="sub">
        Profi-Check in 5 Sekunden: <span class="mono">Sehen?</span> + <span class="mono">Wolken?</span> + <span class="mono">Aurora-Lage?</span>
      </div>
      <div class="mini">
        <span class="chip"><span class="dot info"></span> Auto-Update: <strong id="autoEvery">60s</strong></span>
        <span class="chip"><span class="dot" id="dotNow"></span> Status: <strong id="statusText">l√§dt‚Ä¶</strong></span>
        <span class="chip">Letztes Update: <strong id="lastUpdate">‚Äî</strong></span>
      </div>
    </div>

    <div class="controls">
      <div class="field">
        <label for="locName">Ort / Standort</label>
        <input id="locName" type="text" placeholder="z.B. Chemnitz ‚Äì Feldrand" />
      </div>
      <div class="field">
        <label for="lat">Lat</label>
        <input id="lat" class="small" type="number" step="0.0001" />
      </div>
      <div class="field">
        <label for="lon">Lon</label>
        <input id="lon" class="small" type="number" step="0.0001" />
      </div>
      <button id="btnUpdate">Aktualisieren</button>
      <button id="btnSave">Speichern</button>
    </div>
  </div>

  <div class="grid">

    <!-- LEFT: DECISION + MAPS -->
    <div class="card">
      <header>
        <h2>‚úÖ Entscheidung & Bedingungen</h2>
        <span class="chip"><span class="dot info"></span> Jetzt z√§hlt: <strong>Sichtbarkeit in DE</strong> (Tag/D√§mmerung wird ber√ºcksichtigt)</span>
      </header>
      <div class="body hero">

        <div class="decision">
          <div class="left">
            <div class="title">Ort / Standort</div>
            <div class="big" id="locTitle">‚Äî</div>
            <div class="explain" id="decisionExplain">‚Äî</div>
          </div>
          <div class="right">
            <div class="pill info" id="goPill"><span class="dot info"></span><span id="goText">lade‚Ä¶</span></div>
            <div class="muted">Score: <strong id="scoreNow">‚Äî</strong>/100 (JETZT)</div>
            <div class="muted">Score: <strong id="scoreNight">‚Äî</strong>/100 (N√ÑCHSTE NACHT)</div>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="label">Licht / Himmel</div>
            <div class="value" id="kpiDark">‚Äî</div>
            <div class="hint" id="kpiDarkHint">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">Wolken (Spot)</div>
            <div class="value" id="kpiCloud">‚Äî</div>
            <div class="hint" id="kpiCloudHint">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">Aurora-Lage (NOAA)</div>
            <div class="value" id="kpiAurora">‚Äî</div>
            <div class="hint" id="kpiAuroraHint">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">Kp (planetar)</div>
            <div class="value" id="kpiKp">‚Äî</div>
            <div class="hint" id="kpiKpHint">‚Äî</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="maps">
          <figure>
            <figcaption>Deutschland ‚Äì aktuell (MTWetter)</figcaption>
            <img class="autoRefresh"
                 data-src="https://aurora.mtwetter.de/realtime/aurora_probability_map_nightMode.png"
                 alt="Aurora Probability Map - aktuell" />
          </figure>
          <figure>
            <figcaption>Deutschland ‚Äì 1h Maximum (MTWetter)</figcaption>
            <img class="autoRefresh"
                 data-src="https://aurora.mtwetter.de/realtime/aurora_probability_map_1h_nightMode.png"
                 alt="Aurora Probability Map - 1h" />
          </figure>
          <figure>
            <figcaption>Deutschland ‚Äì 6h Maximum (MTWetter)</figcaption>
            <img class="autoRefresh"
                 data-src="https://aurora.mtwetter.de/realtime/aurora_probability_map_6h_nightMode.png"
                 alt="Aurora Probability Map - 6h" />
          </figure>
        </div>

        <p class="explain">
          Tipp: F√ºr dich als Fotograf z√§hlt vor allem: <strong>dunkel genug</strong> + <strong>wenig Wolken</strong> + <strong>genug Aktivit√§t</strong>.
          Tags√ºber wird der ‚ÄûJETZT-Score‚Äú automatisch abgewertet, selbst wenn die Aurora-Lage hoch ist.
        </p>
      </div>
    </div>

    <!-- RIGHT: WEATHER + SOURCES -->
    <div style="display:flex; flex-direction:column; gap:14px;">

      <div class="card">
        <header>
          <h2>‚òÅÔ∏è Wetter (Widget) & üåÖ Tageslicht</h2>
          <span class="chip"><span class="dot info"></span> Quelle: wetter.de Widgets</span>
        </header>
        <div class="body">
          <div class="iframeWrap" style="margin-bottom:10px;">
            <!-- 3-Tage Widget (dein Code) -->
            <iframe style="height:215px; background-color: transparent;"
                    id="wetterWidget"
                    src="https://www.wetter.de/widget/3tage/u311njez/false/"></iframe>
          </div>

          <div class="iframeWrap">
            <!-- Daylight Widget (dein Code) -->
            <iframe style="height:290px; background-color: transparent;"
                    id="daylightWidget"
                    src="https://www.wetter.de/widget/daylight/u311njez"></iframe>
          </div>

          <p class="explain">
            Der Linktext wird absichtlich statisch gesetzt (damit kein <span class="mono">[object Promise]</span> erscheint):
            <a href="https://www.wetter.de" rel="nofollow noopener" target="_blank">Wetter & Sonnenzeiten (wetter.de)</a>
          </p>
        </div>
      </div>

      <div class="card">
        <header>
          <h2>üß© Datenquellen Monitor</h2>
          <span class="chip"><span class="dot info"></span> schnell sehen, ob alles l√§dt</span>
        </header>
        <div class="body">
          <ul class="sources">
            <li>
              <div class="left">
                <span class="dot" id="s-mtwetter"></span>
                <a href="https://aurora.mtwetter.de/" target="_blank" rel="noopener">aurora.mtwetter.de</a>
                <span class="tag">DE Karten</span>
              </div>
              <div class="rightnote" id="note-mtwetter">‚Äî</div>
            </li>
            <li>
              <div class="left">
                <span class="dot" id="s-noaa"></span>
                <a href="https://www.swpc.noaa.gov/products/aurora-30-minute-forecast" target="_blank" rel="noopener">NOAA / SWPC</a>
                <span class="tag">KP + Ovation</span>
              </div>
              <div class="rightnote" id="note-noaa">‚Äî</div>
            </li>
            <li>
              <div class="left">
                <span class="dot" id="s-openmeteo"></span>
                <a href="https://open-meteo.com/" target="_blank" rel="noopener">Open-Meteo</a>
                <span class="tag">Wolken (API)</span>
              </div>
              <div class="rightnote" id="note-openmeteo">‚Äî</div>
            </li>
          </ul>

          <div class="sep"></div>
          <p class="explain">
            <strong>Wie ich den Score baue:</strong><br/>
            ‚Ä¢ ‚ÄûJETZT‚Äú = Aurora-Aktivit√§t √ó (1 ‚àí Wolken) √ó <strong>Sichtbarkeit (Dunkelheit)</strong><br/>
            ‚Ä¢ ‚ÄûN√ÑCHSTE NACHT‚Äú = gleiche Logik, aber mit Dunkelheits-Faktor f√ºr die n√§chste echte Dunkelphase.<br/>
            So bekommst du keine ‚Äûfalschen Alarm-Momente‚Äú um 13:16 Uhr.
          </p>
        </div>
      </div>

    </div>
  </div>

  <div class="footer">
    Aurora X ‚Äì kompakt & praxisnah. Quellen: NOAA/SWPC (KP/Ovation/Solarwind), MTWetter Karten, Open-Meteo (Wolken), wetter.de Widgets.
  </div>
</div>

<script>
/**
 * AURORA X ‚Äì FINAL (Single-File)
 * ----------------------------------------------------
 * Ziele:
 * 1) Sofort klare Entscheidung ("RAUSGEHEN?") ‚Äì auch f√ºr Laien.
 * 2) Profi-Infos: Kp, Solarwind-Indikatoren, Aurora-Aktivit√§t, Wolken.
 * 3) Tags√ºber keine "Fake-Riesen-Wahrscheinlichkeit": Sichtbarkeit wird √ºber Sonnenstand ged√§mpft.
 *
 * Datenquellen (√∂ffentlich):
 * - NOAA/SWPC: Kp, Ovation Aurora, Solarwind:
 *   https://services.swpc.noaa.gov/
 * - Open-Meteo: Wolken:
 *   https://api.open-meteo.com/
 * - MTWetter: Deutschlandkarten (PNG):
 *   https://aurora.mtwetter.de/
 */

const AUTO_REFRESH_MS = 60_000;

// Default Standort (Chemnitz)
const DEFAULTS = {
  name: "Chemnitz ‚Äì Standort",
  lat: 50.8278,
  lon: 12.9214,
};

// ---------- UI helpers ----------
const $ = (id) => document.getElementById(id);

function setDot(el, state){
  // state: ok|warn|bad|info
  el.className = "dot " + (state || "");
}

function fmt(n, digits=1){
  if (n === null || n === undefined || Number.isNaN(n)) return "‚Äî";
  return Number(n).toFixed(digits);
}

function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

// ---------- Local storage ----------
const KEY = "auroraX_location_v1";

function loadLocation(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return DEFAULTS;
    const v = JSON.parse(raw);
    if(!v || typeof v !== "object") return DEFAULTS;
    return {
      name: String(v.name || DEFAULTS.name),
      lat: Number(v.lat ?? DEFAULTS.lat),
      lon: Number(v.lon ?? DEFAULTS.lon),
    };
  }catch{ return DEFAULTS; }
}

function saveLocation(loc){
  localStorage.setItem(KEY, JSON.stringify(loc));
}

// ---------- Sun position (no external libs) ----------
// Minimal NOAA-style solar position approximation for altitude.
// Good enough to classify: day / civil / nautical / astronomical / night.
function toJulian(date){ return date / 86400000 - 0.5 + 2440588; }
function toDays(date){ return toJulian(date) - 2451545; }
function rad(deg){ return deg * Math.PI / 180; }
function deg(rad){ return rad * 180 / Math.PI; }

function solarMeanAnomaly(d){ return rad(357.5291 + 0.98560028 * d); }
function eclipticLongitude(M){
  const C = rad(1.9148) * Math.sin(M) + rad(0.02) * Math.sin(2*M) + rad(0.0003) * Math.sin(3*M);
  const P = rad(102.9372);
  return M + C + P + Math.PI;
}
function declination(L){
  const e = rad(23.4397);
  return Math.asin(Math.sin(e) * Math.sin(L));
}
function rightAscension(L){
  const e = rad(23.4397);
  return Math.atan2(Math.cos(e) * Math.sin(L), Math.cos(L));
}
function siderealTime(d, lw){
  return rad(280.16 + 360.9856235 * d) - lw;
}

function sunAltitude(date, lat, lon){
  const lw = rad(-lon);
  const phi = rad(lat);
  const d = toDays(date);
  const M = solarMeanAnomaly(d);
  const L = eclipticLongitude(M);
  const dec = declination(L);
  const ra = rightAscension(L);
  const st = siderealTime(d, lw);
  const H = st - ra;

  const alt = Math.asin(Math.sin(phi)*Math.sin(dec) + Math.cos(phi)*Math.cos(dec)*Math.cos(H));
  return deg(alt);
}

function darknessClass(altDeg){
  // thresholds by solar altitude:
  // > 0: day
  // 0..-6: civil twilight
  // -6..-12: nautical twilight
  // -12..-18: astronomical twilight
  // < -18: night
  if (altDeg > 0) return {name:"Tag", key:"day", factor:0.0, hint:"Zu hell ‚Äì visuell praktisch unm√∂glich."};
  if (altDeg > -6) return {name:"B√ºrgerl. D√§mmerung", key:"civil", factor:0.15, hint:"Sehr hell ‚Äì nur extremes Event fotografisch evtl."};
  if (altDeg > -12) return {name:"Naut. D√§mmerung", key:"nautical", factor:0.45, hint:"Besser ‚Äì erste Foto-Chancen bei guter Aktivit√§t."};
  if (altDeg > -18) return {name:"Astr. D√§mmerung", key:"astro", factor:0.75, hint:"Sehr gut ‚Äì Himmel dunkel genug."};
  return {name:"Nacht", key:"night", factor:1.0, hint:"Optimal ‚Äì maximale Sichtbarkeit."};
}

function nextNightFactorWindow(lat, lon){
  // N√§chste 24h st√ºndlich scannen, besten Dunkelheitsfaktor nehmen
  const now = new Date();
  let best = 0;
  let bestAt = null;
  for(let h=0; h<=24; h++){
    const t = new Date(now.getTime() + h*3600*1000);
    const alt = sunAltitude(t, lat, lon);
    const dc = darknessClass(alt);
    if(dc.factor > best){
      best = dc.factor;
      bestAt = t;
    }
  }
  return {bestFactor: best, bestTime: bestAt};
}

// ---------- NOAA / SWPC fetch ----------
async function fetchJSON(url, timeoutMs=8000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeoutMs);
  try{
    const res = await fetch(url, {signal: ctrl.signal, cache:"no-store"});
    if(!res.ok) throw new Error("HTTP " + res.status);
    return await res.json();
  } finally {
    clearTimeout(t);
  }
}

async function getKpLatest(){
  // returns latest Kp from NOAA planetary K-index product (table JSON)
  // format: [ [time_tag, kp, ...], ... ]
  const url = "https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json";
  const data = await fetchJSON(url);
  // skip header row
  const rows = data.slice(1).filter(r => r && r.length >= 2);
  const last = rows[rows.length - 1];
  return { kp: Number(last[1]), time: new Date(last[0] + "Z") };
}

async function getSolarWindLatest(){
  // Bz from mag-1-day, speed from plasma-1-day
  const magUrl = "https://services.swpc.noaa.gov/products/solar-wind/mag-1-day.json";
  const plaUrl = "https://services.swpc.noaa.gov/products/solar-wind/plasma-1-day.json";
  const [mag, pla] = await Promise.all([fetchJSON(magUrl), fetchJSON(plaUrl)]);
  const magRows = mag.slice(1).filter(r => r && r.length >= 7);
  const plaRows = pla.slice(1).filter(r => r && r.length >= 4);

  const m = magRows[magRows.length - 1];
  const p = plaRows[plaRows.length - 1];

  // mag columns (typical): time_tag, bx, by, bz, bt, lat, lon (varies)
  const time = new Date(m[0] + "Z");
  const bz = Number(m[3]);
  // plasma columns (typical): time_tag, density, speed, temp
  const speed = Number(p[2]);
  const density = Number(p[1]);

  return { time, bz, speed, density };
}

async function getOvationValueNear(lat, lon){
  // Ovation grid values; we pick nearest point by great-circle approx.
  const url = "https://services.swpc.noaa.gov/json/ovation_aurora_latest.json";
  const data = await fetchJSON(url);
  // data is array of objects: { "Latitude":..., "Longitude":..., "Aurora":... } (fields may vary)
  // Normalize keys:
  const arr = Array.isArray(data) ? data : (data.coordinates || data.data || []);
  if(!Array.isArray(arr) || arr.length === 0) return { value: null, time: null };

  let best = null;
  let bestDist = Infinity;
  for(const it of arr){
    const la = Number(it.Latitude ?? it.latitude ?? it.lat);
    const lo = Number(it.Longitude ?? it.longitude ?? it.lon);
    const val = Number(it.Aurora ?? it.aurora ?? it.value);
    if(!Number.isFinite(la) || !Number.isFinite(lo) || !Number.isFinite(val)) continue;

    // handle lon wrap
    let dLon = Math.abs(lo - lon);
    dLon = Math.min(dLon, 360 - dLon);
    const dLat = la - lat;
    const dist = dLat*dLat + dLon*dLon;
    if(dist < bestDist){
      bestDist = dist;
      best = { la, lo, val };
    }
  }

  // time often included separately
  const issueTime = data.ObservationTime ?? data.observation_time ?? data.time_tag ?? null;
  const time = issueTime ? new Date(String(issueTime).replace("Z","") + "Z") : null;

  return { value: best ? best.val : null, time };
}

// ---------- Open-Meteo clouds ----------
async function getCloudCover(lat, lon){
  const url = "https://api.open-meteo.com/v1/forecast?latitude=" + encodeURIComponent(lat) +
              "&longitude=" + encodeURIComponent(lon) +
              "&current=cloud_cover,weather_code" +
              "&timezone=auto";
  const data = await fetchJSON(url);
  const cur = data.current || {};
  const cloud = Number(cur.cloud_cover);
  const wcode = cur.weather_code;
  const time = cur.time ? new Date(cur.time) : null;
  return { cloud, wcode, time };
}

// ---------- Score logic ----------
function auroraLabelFromKp(kp){
  if(!Number.isFinite(kp)) return "‚Äî";
  if(kp >= 7) return "SEHR HOCH";
  if(kp >= 6) return "HOCH";
  if(kp >= 5) return "GUT";
  if(kp >= 4) return "M√ÑSSIG";
  return "RUHIG";
}

function cloudLabel(cloud){
  if(!Number.isFinite(cloud)) return "‚Äî";
  if(cloud <= 20) return "klar";
  if(cloud <= 50) return "teilweise";
  if(cloud <= 75) return "wolkig";
  return "zu";
}

function normalizeAurora(ovationVal, kp, bz, speed){
  // Build a 0..1 "activity" score from multiple cues.
  // Ovation "Aurora" values can be 0..100-ish (varies). Normalize gently.
  const ov = Number.isFinite(ovationVal) ? clamp(ovationVal / 80, 0, 1) : 0.0;
  const kpn = Number.isFinite(kp) ? clamp((kp - 2) / 6, 0, 1) : 0.0;

  // bz: negative helps, positive hurts
  const bzN = Number.isFinite(bz) ? clamp((-bz) / 10, 0, 1) : 0.0;

  // speed: higher helps (rough proxy)
  const spN = Number.isFinite(speed) ? clamp((speed - 350) / 400, 0, 1) : 0.0;

  // weighted blend
  return clamp(0.45*ov + 0.30*kpn + 0.15*bzN + 0.10*spN, 0, 1);
}

function computeScoreNow({lat, lon, cloud, kp, bz, speed, ovationVal}){
  const alt = sunAltitude(new Date(), lat, lon);
  const dark = darknessClass(alt);

  const activity = normalizeAurora(ovationVal, kp, bz, speed);
  const cloudFactor = Number.isFinite(cloud) ? (1 - clamp(cloud/100, 0, 1)) : 0.6;

  // the key: daylight kills visibility
  const score = Math.round(100 * activity * cloudFactor * dark.factor);

  return { score, dark, alt, activity, cloudFactor };
}

function computeScoreNight({lat, lon, cloud, kp, bz, speed, ovationVal}){
  const win = nextNightFactorWindow(lat, lon);
  const activity = normalizeAurora(ovationVal, kp, bz, speed);
  const cloudFactor = Number.isFinite(cloud) ? (1 - clamp(cloud/100, 0, 1)) : 0.6;
  const score = Math.round(100 * activity * cloudFactor * win.bestFactor);
  return { score, bestTime: win.bestTime, bestFactor: win.bestFactor, activity, cloudFactor };
}

function decidePill(scoreNow, darkKey){
  // decision is primarily for "go now". If day/civil, keep it conservative.
  if(darkKey === "day"){
    return { cls:"info", text:"JETZT: TAG (Planen statt rausgehen)" };
  }
  if(scoreNow >= 65) return { cls:"ok", text:"RAUSGEHEN: JA (gute Chancen)" };
  if(scoreNow >= 35) return { cls:"warn", text:"RAUSGEHEN: VIELLEICHT (kommt drauf an)" };
  return { cls:"bad", text:"RAUSGEHEN: EHER NEIN" };
}

// ---------- MTWetter image refresh ----------
function refreshImages(){
  document.querySelectorAll("img.autoRefresh").forEach(img => {
    const base = img.dataset.src;
    img.src = base + (base.includes("?") ? "&" : "?") + "t=" + Date.now();
  });
}

// ---------- Source monitor ----------
async function pingImage(url, timeoutMs=7000){
  return new Promise(resolve => {
    const img = new Image();
    const t = setTimeout(() => resolve(false), timeoutMs);
    img.onload = () => { clearTimeout(t); resolve(true); };
    img.onerror = () => { clearTimeout(t); resolve(false); };
    img.src = url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();
  });
}

function setSourceState(idDot, idNote, state, note){
  setDot($(idDot), state);
  $(idNote).textContent = note || "‚Äî";
}

// ---------- Main update ----------
async function updateAll(){
  setDot($("dotNow"), "info");
  $("statusText").textContent = "l√§dt‚Ä¶";

  const loc = {
    name: $("locName").value.trim() || DEFAULTS.name,
    lat: Number($("lat").value),
    lon: Number($("lon").value),
  };

  $("locTitle").textContent = loc.name;

  // Show immediate darkness info even if APIs fail
  const alt = sunAltitude(new Date(), loc.lat, loc.lon);
  const darkNow = darknessClass(alt);
  $("kpiDark").textContent = darkNow.name;
  $("kpiDarkHint").textContent = darkNow.hint;

  // Default placeholders
  $("kpiCloud").textContent = "‚Äî";
  $("kpiCloudHint").textContent = "Open-Meteo l√§dt‚Ä¶";
  $("kpiAurora").textContent = "‚Äî";
  $("kpiAuroraHint").textContent = "NOAA Ovation l√§dt‚Ä¶";
  $("kpiKp").textContent = "‚Äî";
  $("kpiKpHint").textContent = "NOAA Kp l√§dt‚Ä¶";

  // Fire image refresh
  refreshImages();

  // Load data in parallel
  let kpData=null, sw=null, ov=null, cloud=null;

  const tasks = [
    (async()=>{ kpData = await getKpLatest(); })(),
    (async()=>{ sw = await getSolarWindLatest(); })(),
    (async()=>{ ov = await getOvationValueNear(loc.lat, loc.lon); })(),
    (async()=>{ cloud = await getCloudCover(loc.lat, loc.lon); })(),
  ];

  // Source monitor pings
  const pingTasks = [
    (async()=>{
      const ok = await pingImage("https://aurora.mtwetter.de/realtime/aurora_probability_map_nightMode.png");
      setSourceState("s-mtwetter","note-mtwetter", ok ? "ok":"bad", ok ? "OK" : "Down/Timeout");
    })(),
    (async()=>{
      // simple ping via a fetch try (NOAA)
      try { await fetchJSON("https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json", 7000);
        setSourceState("s-noaa","note-noaa","ok","OK");
      } catch { setSourceState("s-noaa","note-noaa","bad","Down/Timeout"); }
    })(),
    (async()=>{
      try { await fetchJSON("https://api.open-meteo.com/v1/forecast?latitude=50&longitude=10&current=cloud_cover&timezone=auto", 7000);
        setSourceState("s-openmeteo","note-openmeteo","ok","OK");
      } catch { setSourceState("s-openmeteo","note-openmeteo","bad","Down/Timeout"); }
    })(),
  ];

  let okAll = true;
  try{
    await Promise.allSettled([...tasks, ...pingTasks]);
  }catch{
    okAll = false;
  }

  // Fill UI from what we got
  const kp = kpData?.kp;
  const kpTime = kpData?.time;
  if (Number.isFinite(kp)) {
    $("kpiKp").textContent = fmt(kp, 1);
    $("kpiKpHint").textContent = auroraLabelFromKp(kp) + (kpTime ? (" ¬∑ " + kpTime.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"})) : "");
  } else {
    $("kpiKpHint").textContent = "nicht verf√ºgbar";
    okAll = false;
  }

  const bz = sw?.bz;
  const speed = sw?.speed;
  const density = sw?.density;

  const ovVal = ov?.value;
  if (Number.isFinite(ovVal)) {
    $("kpiAurora").textContent = fmt(ovVal, 0);
    const t = ov?.time ? ov.time.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"}) : "‚Äî";
    $("kpiAuroraHint").textContent = "Ovation nahe Spot ¬∑ " + t;
  } else {
    $("kpiAuroraHint").textContent = "nicht verf√ºgbar";
    okAll = false;
  }

  const cloudPct = cloud?.cloud;
  if (Number.isFinite(cloudPct)) {
    $("kpiCloud").textContent = fmt(cloudPct, 0) + "%";
    const t = cloud?.time ? cloud.time.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"}) : "‚Äî";
    $("kpiCloudHint").textContent = cloudLabel(cloudPct) + " ¬∑ " + t;
  } else {
    $("kpiCloudHint").textContent = "nicht verf√ºgbar";
    okAll = false;
  }

  // Compute scores
  const nowRes = computeScoreNow({
    lat: loc.lat, lon: loc.lon,
    cloud: cloudPct, kp, bz, speed, ovationVal: ovVal
  });

  const nightRes = computeScoreNight({
    lat: loc.lat, lon: loc.lon,
    cloud: cloudPct, kp, bz, speed, ovationVal: ovVal
  });

  $("scoreNow").textContent = String(nowRes.score);
  $("scoreNight").textContent = String(nightRes.score);

  // Decision pill
  const pill = decidePill(nowRes.score, nowRes.dark.key);
  const goPill = $("goPill");
  goPill.className = "pill " + pill.cls;
  goPill.querySelector(".dot").className = "dot " + pill.cls;
  $("goText").textContent = pill.text;

  // Explain line (human-friendly, photographer-friendly)
  const parts = [];
  parts.push("Dunkelheit: " + nowRes.dark.name);
  if (Number.isFinite(cloudPct)) parts.push("Wolken: " + fmt(cloudPct,0) + "%");
  if (Number.isFinite(kp)) parts.push("Kp: " + fmt(kp,1));
  if (Number.isFinite(bz)) parts.push("Bz: " + fmt(bz,1) + " nT");
  if (Number.isFinite(speed)) parts.push("Speed: " + fmt(speed,0) + " km/s");
  $("decisionExplain").textContent =
    parts.join(" ¬∑ ") +
    (nowRes.dark.key === "day" ? " ¬∑ Tags√ºber = praktisch nicht sichtbar ‚Üí Score runter." : "");

  // Update status
  const upd = new Date();
  $("lastUpdate").textContent = upd.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit",second:"2-digit"});

  $("statusText").textContent = okAll ? "OK" : "teilweise";
  setDot($("dotNow"), okAll ? "ok" : "warn");
}

// ---------- Wire up ----------
function init(){
  const loc = loadLocation();
  $("locName").value = loc.name;
  $("lat").value = loc.lat;
  $("lon").value = loc.lon;

  $("locTitle").textContent = loc.name;
  $("autoEvery").textContent = Math.round(AUTO_REFRESH_MS/1000) + "s";

  $("btnUpdate").addEventListener("click", updateAll);
  $("btnSave").addEventListener("click", () => {
    const loc2 = {
      name: $("locName").value.trim() || DEFAULTS.name,
      lat: Number($("lat").value),
      lon: Number($("lon").value),
    };
    saveLocation(loc2);
    // tiny feedback
    $("statusText").textContent = "gespeichert";
    setDot($("dotNow"), "info");
    setTimeout(()=>updateAll(), 250);
  });

  // First load
  updateAll();

  // Auto refresh
  setInterval(updateAll, AUTO_REFRESH_MS);
  // refresh map images more often? keep same cycle for simplicity
  setInterval(refreshImages, AUTO_REFRESH_MS);
}

init();
</script>
</body>
</html>
